---
unique_id: unavailable_count
name: Unavailable count
icon: mdi:alert
    #value_template: '{{ states | selectattr("state","eq","unavailable") | map(attribute="entity_id") | list | count }}'
state_class: total
state: |
  {% set storage = namespace(entities="") %}
  {% set entities = states | selectattr("state","eq","unavailable") | rejectattr("entity_id","eq","sensor.unavailable_count") | rejectattr("attributes.type","eq","browser_mod") | map(attribute="entity_id") | list %}
  {%- for entity in entities %}
    {%- set object_id = entity.split(".")[1] %}
    {%- if not object_id.startswith("blackpc_")
          and not object_id.startswith("browser_mod")
          and not object_id.startswith("glowforge") 
          and not object_id.startswith("google_") 
          and not object_id.endswith("_alarms")
          and not object_id.endswith("_timers")
          and not object_id.startswith("hp_")
          and not entity.startswith("media_player")
          and not object_id.startswith("octoprint_")
          and not object_id.startswith("unraid_") %}
      {%- set storage.entities = storage.entities ~ entity %}
      {% if not loop.last %}
        {%- set storage.entities = storage.entities ~ ',' %}
      {% endif %}
    {% endif %}
  {%- endfor %}
  {{ storage.entities.split(",") | count }}
attributes:
  entities: |
    {% set storage = namespace(entities="") %}
    {% set entities = states | selectattr("state","eq","unavailable") | rejectattr("entity_id","eq","sensor.unavailable_count") | rejectattr("attributes.type","eq","browser_mod") | map(attribute="entity_id") | list %}
    {%- for entity in entities %}
      {%- set object_id = entity.split(".")[1] %}
      {%- if not object_id.startswith("blackpc_")
            and not object_id.startswith("browser_mod")
            and not object_id.startswith("glowforge") 
            and not object_id.startswith("google_") 
            and not object_id.endswith("_alarms")
            and not object_id.endswith("_timers")
            and not object_id.startswith("hp_")
            and not entity.startswith("media_player")
            and not object_id.startswith("octoprint_")
            and not object_id.startswith("unraid_") %}
        {%- set storage.entities = storage.entities ~ entity %}
        {% if not loop.last %}
          {%- set storage.entities = storage.entities ~ ',' %}
        {% endif %}
      {% endif %}
    {%- endfor %}
    {{ storage.entities.split(",") }}
