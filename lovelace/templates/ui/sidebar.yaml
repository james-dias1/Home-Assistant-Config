---
card:
  type: vertical-stack
  cards:
    # Sidebar
    - type: custom:card-templater
      entities:
        - sensor.time
      card:
        type: markdown
        style: |
          ha-card {
            background: none;
            box-shadow: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 5.41em;
            font-weight: 500;
            letter-spacing: '-0.05em';
            padding: 0.4em 0;
            text-align: center;
          }
        content_template: >
          {{ "%0.1d:%0.02d"|format(now().strftime("%I")|int,now().minute) }}

    - type: vertical-stack
      cards:
        - type: custom:card-templater
          entities:
            - group.actionable_lights
            - sensor.time
            - variable.left_home
          card:
            type: markdown
            style: |
              ha-card {
                background: none;
                box-shadow: none;
                font-size: 1.3em;
                font-weight: 400;
                line-height: 1.7em;
                letter-spacing: 0.03em;
                margin-top: -2em;
                opacity: 0.65;
              }
            content_template: >
              <table style="padding:0;margin:0;" width="100%">
              <tr>
              <td width="30%">{{ now().strftime("%A") }}</b><br>
              <b>{{ now().strftime("%B") + ', ' + now().strftime("%d") }}</b></td>
              <td align="right"><b>Currently: <ha-icon icon={{ state_attr('sensor.today_icon', 'icon') }}></ha-icon> {{ states('sensor.weatherbit_temperature') }}¬∞</b><br>
              {{ states('sensor.today_high')|round }}¬∞ high, {{ states('sensor.today_low')|round }}¬∞ low</td>
              </tr>
              </table>

    - type: vertical-stack
      cards:
        - type: custom:card-templater
          entities:
            - variable.left_home
          card:
            type: markdown
            style: |
              ha-card {
                background: none;
                box-shadow: none;
                font-size: 1.3em;
                font-weight: 400;
                letter-spacing: 0.03em;
                margin: -2em auto 0 auto;
                opacity: 0.65;
              }
            content_template: >
              {% set people = states.person | selectattr('state','eq','not_home') | map(attribute='entity_id') | list -%}
              {% for person in people -%}
                {% if is_state(person, 'not_home') -%}
                  {% set name = state_attr(person,'friendly_name') -%}
                  {% set left = state_attr('variable.left_home',name) -%}
                  {% if left is not none -%}
                    {% set minutes_away = ((as_timestamp(now())|int - as_timestamp(left)|int) / 60)|int -%}
                    {% set hours_away = (minutes_away / 60)|int -%}
              {% if hours_away > 1 and hours_away < 24 -%}
              {{ name }}: away for {{ hours_away }} hr<br>
              {% elif minutes_away < 60 -%}
              {{ name }}: away for {{ minutes_away|int }} min<br>
              {%- endif %}
                  {%- endif %}
                {%- endif %}
              {%- endfor %}

              <table align="center" style="padding:0;margin:0;" width="75%">
              <tr>
                <td>
                  {% macro weekly_chores(name) -%}
                  {% if name == states('input_select.responsibility_dishes_week') -%}
                  {{ name }}: üçΩÔ∏è
                  {% else -%}
                  {{ name }}: üß∫+üí©
                  {% endif -%}
                  {% endmacro -%}
                  {{ weekly_chores("Lucas") -}}
                </td>
                <td align="right">
                  {{ weekly_chores("Kyle") -}}
                </td>
              </tr>
              <!--
              <tr>
                <td colspan="2">

                  {% if now().hour < 5 %}Goodnight üò¥
                  {% elif now().hour < 11 %}Good morning üåÑ
                  {% elif now().hour < 18 %}Good afternoon ‚òÄÔ∏è
                  {% else %}Good evening üåá
                  {% endif %}
                </td>
                <td align="right">
                  {%- set group_id = 'xgroup.actionable_lights' -%}
                  {%- if states(group_id) != 'unknown' -%}
                    {%- set lights = states.light | selectattr('entity_id','in',state_attr(group_id,'entity_id')) | selectattr('state','eq','on') | map(attribute='name') | list -%}
                    {%- if lights|count > 5 -%}
                      <b>{{ lights|count }}</b> üí° are on
                    {%- elif lights|count > 1 -%}
                      {%- for light in lights -%}üí°{%- endfor %} are on
                    {%- elif lights|count == 1 -%}
                      <b>üí°</b> is on
                    {%- endif -%}
                  {%- endif -%}
                </td>
              </tr>
              -->
              </table>

    - type: vertical-stack
      style: |
        ha-card {
          background: rgba(128, 0, 0, 0.3);
          box-shadow: none;
          border-radius: 0;
          color: white;
          max-height: 50%;
          --paper-item-icon-color: white;
          --paper-item-icon-active-color: white;
          margin: 0;
          padding: 0 1em 0 1em;
        }
        ha-card a {
          color: white;
        }
      cards:
        - type: custom:home-feed-card
          style: |
            ha-card {
              background: rgba(128, 0, 0, 0.3);
              box-shadow: none;
              border-radius: 0;
              margin: 0;
              padding: 0 1.5em;
            }
          title: ""
          compact_mode: false
          more_info_on_tap: true
          show_empty: false
          show_notification_title: true
          entities: !include ../../../templates/ui/notifications.yaml

        - type: 'custom:auto-entities'
          card:
            type: entities
            style: |
              ha-card {
                background: rgba(128, 0, 0, 0.3);
                box-shadow: none;
                border-radius: 0;
                margin: 0;
                padding: 0;
              }
          show_empty: false
          sort:
            method: state
            numeric: true
          filter:
            include:
              - entity_id: sensor.*_battery
            exclude:
              - state: '>30'
              - entity_id: '*ipad*'
              - entity_id: '*iphone*'
              - entity_id: '*life360*'
              - entity_id: '*macbook*'
              - entity_id: '*watch*'

    - type: vertical-stack
      cards:
        - type: entity-filter
          entities:
            - input_select.brian
            - input_select.nerene
            - input_select.lucas
            - input_select.eric
            - input_select.sandy
            - input_select.heather
          state_filter:
            - Home
            - Just Arrived
          card:
            type: 'custom:badge-card'

        - type: horizontal-stack
          cards:
            - type: custom:decluttering-card
              template: icon_button
              variables:
                - icon: mdi:refresh
                - tap_action:
                    action: call-service
                    service: browser_mod.lovelace_reload
                    service_data:
                      deviceID:
                        - this

            - type: custom:decluttering-card
              template: icon_button
              variables:
                - icon: mdi:server
                - tap_action:
                    action: call-service
                    service: browser_mod.popup
                    service_data:
                      title: System
                      card:
                        type: custom:decluttering-card
                        template: popup_system
                      deviceID:
                        - this

            - type: custom:decluttering-card
              template: icon_button
              variables:
                - icon: mdi:amazon-alexa
                - tap_action:
                    action: call-service
                    service: browser_mod.popup
                    service_data:
                      title: Alexa
                      card:
                        type: custom:decluttering-card
                        template: popup_alexa
                      deviceID:
                        - this

            - type: custom:decluttering-card
              template: icon_button
              variables:
                - icon: mdi:weather-cloudy
                - tap_action:
                    action: call-service
                    service: browser_mod.popup
                    service_data:
                      title: Weather Forecast
                      card:
                        type: custom:decluttering-card
                        template: popup_weather
                      deviceID:
                        - this

            - type: custom:decluttering-card
              template: icon_button
              variables:
                - icon: mdi:robot
                - tap_action:
                    action: call-service
                    service: browser_mod.popup
                    service_data:
                      title: Modes, Other, + Routines
                      card:
                        type: custom:decluttering-card
                        template: popup_routines
                      deviceID:
                        - this
