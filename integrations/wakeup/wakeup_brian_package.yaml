---
automation:
  alias: wakeup_brian_light
  #initial_state: true
  trigger:
    platform: template
    value_template: "{{ states('sensor.time') == states('sensor.wakeup_brian_light')|timestamp_custom('%H:%M', false) }}"
  condition:
    - condition: state
      entity_id: person.brian
      state: home
    # Continue today is a wakeup day.
    - condition: state
      entity_id: binary_sensor.wakeup_brian_day
      state: "on"
  action:
    # - service: persistent_notification.create
    #   data_template:
    #     title: "DEBUG"
    #     message: "{{ 'script.wakeup_skipnext' if is_state('input_boolean.wakeup_brian_skipnext', 'on') else 'script.wakeup_light_start' }}"

    - service_template: "{{ 'script.wakeup_skipnext' if is_state('input_boolean.wakeup_brian_skipnext', 'on') else 'script.wakeup_light_start' }}"
      data_template:
        light: "light.glowforge"
        scene: "scene.wakeup_brian"
        skipnext: "input_boolean.wakeup_brian_skipnext"

binary_sensor:
  - platform: template
    sensors:
      wakeup_brian_day:
        entity_id: sensor.date
        friendly_name: Wakeup Brian Today?
        value_template: >-
          {% set   day_name = now().strftime("%A")|lower -%}
          {%- if   day_name == 'monday'    and is_state('input_boolean.wakeup_brian_mon','on') -%}{{true}}
          {%- elif day_name == 'tuesday'   and is_state('input_boolean.wakeup_brian_tue','on') -%}{{true}}
          {%- elif day_name == 'wednesday' and is_state('input_boolean.wakeup_brian_wed','on') -%}{{true}}
          {%- elif day_name == 'thursday'  and is_state('input_boolean.wakeup_brian_thu','on') -%}{{true}}
          {%- elif day_name == 'friday'    and is_state('input_boolean.wakeup_brian_fri','on') -%}{{true}}
          {%- elif day_name == 'saturday'  and is_state('input_boolean.wakeup_brian_sat','on') -%}{{true}}
          {%- elif day_name == 'sunday'    and is_state('input_boolean.wakeup_brian_sun','on') -%}{{true}}
          {%- else -%}{{false}}{%- endif %}

input_boolean:
  wakeup_brian_status:
    name: Activate Alarm
    icon: mdi:alarm-check
  wakeup_brian_skipnext:
    name: Skip Next Alarm
    icon: mdi:alarm-check
  wakeup_brian_sun:
    name: Sunday
    icon: mdi:checkbox-marked-circle
  wakeup_brian_mon:
    name: Monday
    icon: mdi:checkbox-marked-circle
  wakeup_brian_tue:
    name: Tuesday
    icon: mdi:checkbox-marked-circle
  wakeup_brian_wed:
    name: Wednesday
    icon: mdi:checkbox-marked-circle
  wakeup_brian_thu:
    name: Thursday
    icon: mdi:checkbox-marked-circle
  wakeup_brian_fri:
    name: Friday
    icon: mdi:checkbox-marked-circle
  wakeup_brian_sat:
    name: Saturday
    icon: mdi:checkbox-marked-circle

input_datetime:
  wakeup_brian_time:
    name: Wakeup Time
    has_date: false
    has_time: true

scene:
  - name: Wakeup Brian
    entities:
      switch.bedroom_fan: off
      light.entry:
        state: on
        brightness_pct: '40'

sensor:
  - platform: template
    sensors:
      wakeup_brian_light:
        friendly_name: Light Fade-in Start
        icon_template: mdi:lightbulb-on-outline
        entity_id: input_datetime.wakeup_brian_time
        value_template: >-
          {%  set wakeup_time    = states("input_datetime.wakeup_brian_time") -%}
          {%- set wakeup_hour    = wakeup_time.split(':')[0] -%}
          {%- set wakeup_minutes = wakeup_time.split(':')[1] -%}
          {%- if (wakeup_minutes | int >= 10) -%}
            {{ "%0.02d:%0.02d"|format(wakeup_hour|int, wakeup_minutes|int -10) }}
          {%- else -%}
            {{ "%0.02d:%0.02d"|format(wakeup_hour|int -1, wakeup_minutes|int +50) }}
          {%- endif -%}

  - platform: template
    sensors:
      wakeup_brian_time:
        friendly_name: Wakeup Time
        icon_template: mdi:clock-outline
        entity_id: input_datetime.wakeup_brian_time
        value_template: >-
          {%  set wakeup_brian_time    = states("input_datetime.wakeup_brian_time") -%}
          {%- set wakeup_brian_hour    = wakeup_brian_time.split(':')[0] -%}
          {%- set wakeup_brian_minutes = wakeup_brian_time.split(':')[1] -%}
          {{ "%0.02d:%0.02d" | format(wakeup_brian_hour|int, wakeup_brian_minutes|int) }}

timer:
  wakeup_timeout_brian_wakeup:
    duration: "01:00:00"
