---
mode: parallel
variables:
  media_player: '{{ media_player|default("media_player.google_kitchen") }}'
  message: '{{ message|striptags }}'
  # mqtt_message_attributes:
  #   target: "{{ media_player }}"
  volume: |
    {%- set volume = volume|replace("%","")|default("0.7") %}
    {%- if volume|float <= 1.0 %}
      {{ volume }}
    {%- else %}
      {{ volume / 100 }}
    {%- endif %}
sequence:
  # Only speak when there is something to say. ;)
  - choose:
      conditions:
        - condition: template
          value_template: '{{ message is not undefined }}'
      sequence:
        - alias: Set volume so announcement can be heard.
          service: media_player.volume_set
          target:
            entity_id: media_player.google_kitchen
          data:
            volume_level: '{{ volume }}'

        - alias: Say the message out loud.
          service: tts.cloud_say
          data:
            entity_id: '{{ media_player }}'
            message: '{{ message }}'
            language: en-US
            options:
              gender: female

      # # Remove "speaker" icon from screen by turning the kitchen media player off.
      # - condition: template
      #   value_template: '{{ media_player in ["media_player.google_kitchen","group.google_downstairs"] }}'
      # - delay:
      #     seconds: 10
      # - service: media_player.turn_off
      #   entity_id: media_player.google_kitchen

  - service: script.toast
    data:
      message: "{{ message }}"

  - alias: Store Last Message.
    service: script.store_mqtt_sensor
    data:
      name: "last_message"
      state: "{{ message }}"
      #attributes: '{{ mqtt_message_attributes }}'

  - alias: Store Last Speaker.
    service: script.store_mqtt_sensor
    data:
      name: "last_speaker"
      state: "{{ media_player }}"


fields:
  message:
    description: Include details here.
    example: The laundry is ready to be moved to the dryer.
    required: true
    selector:
      text:
        multiline: true
  media_player:
    description: Media Player entity_id.
    example: media_player.google_kitchen
    default: media_player.google_family_room
    selector:
      text:
  volume:
    description: Volume level as a percentage (or a decimal from 0 - 1.0)
    example: 60
    selector:
      number:
        min: 0
        max: 100
