---
say:
  sequence:
    - condition: state
      entity_id: input_boolean.speech_notifications
      state: 'on'
    - service: mqtt.publish
      data_template:
        topic: 'speech/last_message'
        payload: "This message is from {{ now().strftime('%-I') }}:{{ now().strftime('%M') }} {{ now().strftime('%p') }}. {{ speech_message | truncate(254)}}"
        retain: true
    - service: media_player.alexa_tts
      data_template:
        entity_id: >-
          {%- macro entity_list(entities) -%}
            {%- if entities is not string -%}
              {%- set temp = 'media_player.living_room' -%}
            {%- else -%}
              {%- set temp = entities|trim|replace(' ', '') -%}
            {%- endif -%}
            {{ temp|replace(' ,',',')|replace(',',', ')|trim }}
          {%- endmacro -%}
          {{ entity_list(media_player) }}
        message: >-
          {# Macros #}
          {%- macro goodnight_line() -%}
            {{ [
              "Goodnight, talk to you tomorrow. ",
              "Ahsta la veesta. Baby. ",
              "Goodnight sweetheart, now its time to go. "
            ]|random }}
          {%- endmacro -%}

          {%- macro greeting_line() -%}
            {%- set hour = now().strftime('%H')|int -%}
            {# Midnight to 10am #}
            {%- if hour > 0 and hour < 10  %}
              Good morning.
            {# 10am to 5pm #}
            {%- elif hour >= 10 and hour < 17 %}
              Good afternoon.
            {# 5pm - Midnight #}
            {%- else %}
              Good evening.
            {%- endif %}
          {%- endmacro -%}


          {# Initialize variables #}
          {%- if say_goodnight == "true" -%}
            {%- set say_greeting = "false" -%}
          {%- else -%}
            {%- set say_goodnight = "false" -%}
          {%- endif -%}

          {%- if say_greeting != "false" -%}
            {%- set say_greeting = "true" -%}
          {%- endif -%}


          {# Main "program" #}
          {%- if say_greeting == "true" -%}
             {{ greeting_line() + " " }}
          {%- endif -%}

          {{ message }}

          {%- if say_goodnight == "true" -%}
            {{ " " + goodnight_line() }}
          {%- endif -%}