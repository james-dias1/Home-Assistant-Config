---
lights_on_update:
  sequence:
    - service: group.set
      data_template:
        object_id: "lights_on"
        entities: >-
          {% set group_id = 'group.actionable_lights' %}
          {% set on_states = ['on'] %}
          {{ states | selectattr('entity_id','in', state_attr(group_id, 'entity_id')) | selectattr('state','in',on_states) | map(attribute='entity_id') | join(', ') }}

    - service: variable.set_variable
      data:
        variable: lights_on
        value_template: >
          {% set group_id = 'group.actionable_lights' %}
          {% set on_states = ['on'] %}
          {{ states | selectattr('entity_id','in', state_attr(group_id, 'entity_id')) | selectattr('state','in',on_states) | map(attribute='entity_id') | join(', ') }}
