---
############################################
## Light brightness adjusts based on time
############################################
lights_by_time:
  alias: "Function: Set Light Brightness By Time Smartly"
  sequence:
    # Only adjust light brightness if someone is home and the Time Based Dimmers are enabled.
    - condition: template
      value_template: "{{ states.input_boolean.away_mode.state == 'off'
                      and states.input_boolean.time_based_dimmers_enabled.state == 'on' }}"
    # Only dim lights when guest mode is NOT active.
    - condition: template
      value_template: "{{ states.input_boolean.guest_mode.state == 'off' }}"

    - service: light.turn_on
      data_template:
        ##########################
        # START  | END    | BRI  #
        # ------ | ------ | ---- #
        # 5am    | 8am    |  60% #
        # 8am    | 7pm    | 100% #
        # 7pm    | 7:30pm |  80% #
        # 7:30pm | 8pm    |  60% #
        # 8pm    | 8:30pm |  50% #
        # 8:30pm | 9pm    |  40% #
        # 9pm    | 5am    |  30% #
        ##########################
        brightness: >
          {% macro get_brightness() -%}
            {%- set hour    = states("sensor.time").split(':')[0] | int -%}
            {%- set minutes = states("sensor.time").split(':')[1] | int -%}
            {%- if   hour >=  5 and hour <  8                   -%}{%- set brightness_pct = 60 -%}
            {%- elif hour >=  8 and hour < 19                  -%}{%-  set brightness_pct = 100 -%}
            {%- elif hour >= 19 and minutes < 30 and hour < 20  -%}{%- set brightness_pct = 70 -%}
            {%- elif hour >= 19 and minutes > 30 and hour < 20  -%}{%- set brightness_pct = 60 -%}
            {%- elif hour >= 20 and minutes < 30 and hour < 21  -%}{%- set brightness_pct = 50 -%}
            {%- elif hour >= 20 and minutes > 30 and hour < 21  -%}{%- set brightness_pct = 40 -%}
            {%- else                                            -%}{%- set brightness_pct = 30 -%}
            {%- endif -%}
            {%- set brightness = brightness_pct * 255 / 100 -%}
            {{ brightness|int }}
          {%- endmacro -%}
          {{ get_brightness() }}
        entity_id: >
          {% macro get_brightness() -%}
            {%- set hour    = states("sensor.time").split(':')[0] | int -%}
            {%- set minutes = states("sensor.time").split(':')[1] | int -%}
            {%- if   hour >=  5 and hour <  8                   -%}{%- set brightness_pct = 60 -%}
            {%- elif hour >=  8 and hour < 19                  -%}{%-  set brightness_pct = 100 -%}
            {%- elif hour >= 19 and minutes < 30 and hour < 20  -%}{%- set brightness_pct = 70 -%}
            {%- elif hour >= 19 and minutes > 30 and hour < 20  -%}{%- set brightness_pct = 60 -%}
            {%- elif hour >= 20 and minutes < 30 and hour < 21  -%}{%- set brightness_pct = 50 -%}
            {%- elif hour >= 20 and minutes > 30 and hour < 21  -%}{%- set brightness_pct = 40 -%}
            {%- else                                            -%}{%- set brightness_pct = 30 -%}
            {%- endif -%}
            {%- set brightness = brightness_pct * 255 / 100 -%}
            {{ brightness|int }}
          {%- endmacro -%}
          {% macro get_lights_to_change(brightness) -%}
            {%- for group in states.light|groupby('state') -%}
              {%- for entity in group.list -%}
                {%- if entity.state == 'on'
                    and state_attr(entity.entity_id, 'brightness') >= brightness|int
                    and entity.entity_id|lower != 'light.3a4e12'
                    and entity.entity_id|lower != 'light.3a4f5b'
                    and entity.entity_id|lower != 'light.3a542c'
                    and entity.entity_id|lower != 'light.3a5e44'
                    and entity.entity_id|lower != 'light.3a76dc'
                    and entity.entity_id|lower != 'light.3a7703'
                    and entity.entity_id|lower != 'light.dummy'
                    and entity.entity_id|lower != 'light.entry'            
                    and entity.entity_id|lower != 'light.hue'
                    and entity.entity_id|lower != 'light.living_room'
                    and not ('garage_entry'  in entity.entity_id|lower)
                    and not ('shoe_closet'   in entity.entity_id|lower)
                    and not ('gateway_light' in entity.entity_id|lower)
                    and not (entity.entity_id|lower).endswith('nightlight')
                    and not (entity.entity_id|lower).endswith('_group') -%}
                  {{ entity.entity_id }}{{ ' ' }}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- endmacro %}
          {%- set lights = get_lights_to_change(get_brightness())|trim|replace(' ', ',') -%}
          {%- if lights|trim != "" -%}{%- set entity_id = lights -%}
          {%- else -%}{%- set entity_id = 'light.dummy' -%}
          {%- endif %}
          {{ entity_id }}