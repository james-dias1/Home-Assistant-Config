---
######################################################################################################
#  Call "notify_mobile" like this:
#    action:
#      service: script.notify_mobile
#      data_template:
#        title: 'Startup: Home Assistant is Up and Running!'
#        message: "{{ trigger.to_state.state }}"
#        who: "brian | nerene | lucas | kyle | family | parents"
#        id: messages with same id are grouped
#        image: "{{ trigger.event.data.entity_picture }}"
#        url: "{{ trigger.event.data.url }}"
######################################################################################################
sequence:
  # Only send if globally enabled.
  - condition: state
    entity_id: input_boolean.mobile_notifications
    state: 'on'
  
  - choose:
    # Send camera stream.
    - conditions:
        - '{{ camera is string }}'
      sequence:
        - service: 'notify.{{ who|default("brian") }}'
          data:
            title: '{{ title }}'
            message: '{{ message }}'
            data:
              attachment:
                content-type: jpeg
              entity_id: '{{ camera }}'
              apns_headers:
                apns-collapse-id: >-
                  {%- if replaceable_id is not string -%}{%- set replaceable_id = none -%}{%- endif -%}
                  {{ replaceable_id }}
              thread-id: >-
                {%- if id is not string -%}{%- set id = "HOMEASSISTANT" -%}{%- endif -%}
                {{ id|upper }}

    # Send an image.
    - conditions:
        - '{{ image is string }}'
      sequence:
        - service: 'notify.{{ who|default("brian") }}'
          data:
            title: '{{ title }}'
            message: '{{ message }}'
            data:
              url: '{{ image }}'
              content-type: |
                {%- set filename = image.split(".") %}
                {%- set extension = filename[filename|length - 1] %}
                {{ extension|replace("jpg","jpeg") }}
              hide-thumbnail: false
              push:
                apns_headers:
                  apns-collapse-id: >-
                    {%- if replaceable_id is not string -%}{%- set replaceable_id = none -%}{%- endif -%}
                    {{ replaceable_id }}
                thread-id: >-
                  {%- if id is not string -%}{%- set id = "HOMEASSISTANT" -%}{%- endif -%}
                  {{ id|upper }}

    # Send a basic message.
    default:
      - service: 'notify.{{ who|default("brian") }}'
        data:
          title: '{{ title }}'
          message: '{{ message }}'
          data:
            push:
              category: '{{ category }}'
              sound: |
                {%- if sound is not string %}
                  {%- if category is string %}
                    Update.caf
                  {% else %}
                    sms-received1.caf
                  {% endif %}
                {%- else %}
                  {{ sound }}
                {%- endif %}
              url: '{{ link or url }}'

              apns_headers:
                apns-collapse-id: >-
                  {%- if replaceable_id is not string -%}{%- set replaceable_id = none -%}{%- endif -%}
                  {{ replaceable_id }}
              thread-id: >-
                {%- if id is not string -%}{%- set id = "HOMEASSISTANT" -%}{%- endif -%}
                {{ id|upper }}
