homeassistant:
  customize:
    binary_sensor.brians_in_bed:
      device_class: occupancy
    binary_sensor.nerenes_in_bed:
      device_class: occupancy

################################################
## Sensors
################################################
binary_sensor:
  - platform: template
    sensors:
      brians_in_bed:
        value_template: "{{ is_state('variable.brians_in_bed', 'on') }}"
        delay_on:
          minutes: 5
        device_class: presence
        friendly_name: "Brian's In Bed"
        icon_template: mdi:hotel

  - platform: template
    sensors:
      nerenes_in_bed:
        value_template: "{{ is_state('variable.nerenes_in_bed', 'on') }}"
        delay_on:
          minutes: 5
        device_class: presence
        friendly_name: "Nerene's In Bed"
        icon_template: mdi:hotel

################################################
## Variables
################################################
variable:
  brians_in_bed:
    value: "off"
  nerenes_in_bed:
    value: "off"

################################################
## Automation
################################################
automation:
  ##############################################################################
  ###  In Bed Presence Detection
  ##############################################################################
  - alias: Hide empty bed states
    trigger:
      - platform: state
        entity_id:
          - sensors.brians_in_bed
          - sensors.nerenes_in_bed
        to: 'off'
    action:
      - service: group.set_visibility
        data_template:
          entity_id: "group.panel_control_{{ trigger.entity_id.split('.')[1] }}"
          visible: False
      - service: group.set_visibility
        data_template:
          entity_id: >
            {%- if  states('binary_sensor.brians_in_bed')  == 'off'
                and states('binary_sensor.nerenes_in_bed') == 'off' -%}
              group.panel_control
            {%- else -%}
              group.panel_control_bed_presence
            {%- endif -%}
          visible: True

  - alias: Reveal bed presence
    trigger:
      - platform: state
        entity_id:
          - sensors.brians_in_bed
          - sensors.nerenes_in_bed
        to: 'on'
    action:
      - service: group.set_visibility
        data_template:
          entity_id: >
            {%- if  states('binary_sensor.brians_in_bed')  == 'on'
                and states('binary_sensor.nerenes_in_bed') == 'on' -%}
              group.panel_control_in_bed
            {%- else -%}
              group.panel_control_bed_presence
            {%- endif -%}
          visible: True

  - alias: "Brian's CPAP Power Usage Stays High"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        above: 8
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        above: 8
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        above: 8
      - service: variable.set_variable
        data:
          variable: brians_in_bed
          value: "on"

  - alias: "Brian's CPAP Power Usage Stays Low"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 5
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 5
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 5
      - service: variable.set_variable
        data:
          variable: brians_in_bed
          value: "off"

  - alias: "Nerene's Bedside Power Usage Stays High"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        above: 16
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        above: 16
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        above: 16
      - service: variable.set_variable
        data:
          variable: nerenes_in_bed
          value: "on"

  - alias: "Nerene's Bedside Power Usage Stays Low"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        below: 15
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        below: 15
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 15
      - service: variable.set_variable
        data:
          variable: nerenes_in_bed
          value: "off"