homeassistant:
  customize:
    binary_sensor.brians_bed_presence:
      device_class: presence
    binary_sensor.nerenes_bed_presence:
      device_class: presence

################################################
## Automation Switches
################################################
input_boolean:
  brians_bed_presence:
    initial: "off"
  nerenes_bed_presence:
    initial: "off"

################################################
## Sensors
################################################
binary_sensor:
  - platform: template
    sensors:
      brians_bed_presence:
        value_template: "{{ states.device_tracker.brian.state == 'home'
                        and states.input_boolean.brians_bed_presence.state == 'on' }}"
        device_class: presence
        friendly_name: "Brian's Bed Presence"
        icon_template: mdi:hotel

  - platform: template
    sensors:
      nerenes_bed_presence:
        value_template: "{{ states.device_tracker.nerene.state == 'home'
                        and states.input_boolean.nerenes_bed_presence.state == 'on' }}"
        device_class: presence
        friendly_name: "Nerene's Bed Presence"
        icon_template: mdi:hotel

################################################
## Automation
################################################
automation:
  ##############################################################################
  ###  In Bed Presence Detection
  ##############################################################################
  - alias: Hide empty bed states
    trigger:
      - platform: state
        entity_id:
          - sensors.brians_in_bed
          - sensors.nerenes_in_bed
        to: 'off'
    action:
      - service: group.set_visibility
        data_template:
          entity_id: "group.panel_control_{{ trigger.entity_id.split('.')[1] }}"
          visible: False
      - service: group.set_visibility
        data_template:
          entity_id: >
            {%- if  states('binary_sensor.brians_in_bed')  == 'off'
                and states('binary_sensor.nerenes_in_bed') == 'off' -%}
              group.panel_control
            {%- elif states('binary_sensor.brians_in_bed')  == 'on' -%}
              group.panel_control_brians_in_bed
            {%- elif states('binary_sensor.nerenes_in_bed')  == 'on' -%}
              group.panel_control_nerenes_in_bed
            {%- endif -%}
          visible: True

  - alias: Reveal bed presence
    trigger:
      - platform: state
        entity_id:
          - sensors.brians_in_bed
          - sensors.nerenes_in_bed
        to: 'on'
    action:
      - service: group.set_visibility
        data_template:
          entity_id: >
            {%- if  states('binary_sensor.brians_in_bed')  == 'on'
                and states('binary_sensor.nerenes_in_bed') == 'on' -%}
              group.panel_control_bed_presence
            {%- elif states('binary_sensor.brians_in_bed')  == 'on' -%}
              group.panel_control_brians_bed_presence
            {%- elif states('binary_sensor.nerenes_in_bed')  == 'on' -%}
              group.panel_control_nerenes_bed_presence
            {%- endif -%}
          visible: True

  - alias: "Brian's CPAP Power Usage Stays High"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        above: 8
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        above: 8
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        above: 8
      - service: input_boolean.turn_on
        entity_id: input_boolean.brians_bed_presence

  - alias: "Brian's CPAP Power Usage Stays Low"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 5
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 5
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 5
      - service: input_boolean.turn_off
        entity_id: input_boolean.brians_bed_presence

  - alias: "Nerene's Bedside Power Usage Stays High"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        above: 16
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        above: 16
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        above: 16
      - service: input_boolean.turn_on
        entity_id: input_boolean.nerenes_bed_presence

  - alias: "Nerene's Bedside Power Usage Stays Low"
    trigger:
      - platform: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        below: 15
    action:
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow02_power_mean
        below: 15
      - delay: 00:02:30  # Waits 2m 30s
      - condition: numeric_state
        entity_id: sensor.sonoff_pow01_power_mean
        below: 15
      - service: input_boolean.turn_off
        entity_id: input_boolean.nerenes_bed_presence