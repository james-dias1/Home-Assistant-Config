# Original: @mf-social https://github.com/mf-social/Home-Assistant/blob/master/packages/virtual_devices/alarm_clocks/
homeassistant:
  customize:
    input_boolean.wakeup_nerene_status:
      persistent: true
    input_datetime.wakeup_nerene_time:
      persistent: true
    input_number.wakeup_nerene_hour:
      persistent: true
    input_number.wakeup_nerene_minutes:
      persistent: true
    input_select.wakeup_nerene_light:
      persistent: true
    input_boolean.wakeup_nerene_mon:
      persistent: true
    input_boolean.wakeup_nerene_tue:
      persistent: true
    input_boolean.wakeup_nerene_wed:
      persistent: true
    input_boolean.wakeup_nerene_thu:
      persistent: true
    input_boolean.wakeup_nerene_fri:
      persistent: true
    input_boolean.wakeup_nerene_sat:
      persistent: true
    input_boolean.wakeup_nerene_sun:
      persistent: true
    input_text.wakeup_nerene_time:
      icon: "mdi:clock"
    sensor.wakeup_nerene_day_label:
      state_card_mode: none

################################################
## Group
################################################
# group:
#   wakeup_nerene:
#     name: "nerene's Wakeup Light"
#     entities:
#       - input_boolean.wakeup_nerene_status
#       - input_number.wakeup_nerene_hour
#       - input_number.wakeup_nerene_minutes
#       - input_select.wakeup_nerene_light
#       - sensor.wakeup_nerene_day_label
#       - input_boolean.wakeup_nerene_mon
#       - input_boolean.wakeup_nerene_tue
#       - input_boolean.wakeup_nerene_wed
#       - input_boolean.wakeup_nerene_thu
#       - input_boolean.wakeup_nerene_fri
#       - input_boolean.wakeup_nerene_sat
#       - input_boolean.wakeup_nerene_sun

#       #- sensor.time
#       #- sensor.wakeup_nerene_time
#       #- sensor.wakeup_nerene_light
#     control: hidden
#     view: no

################################################
## Date/Time Inputs
################################################
input_datetime:
  wakeup_nerene_time:
    name: Start Time
    has_date: false
    has_time: true
    #initial: "00:00"

input_text:
  wakeup_nerene_time:
    name: Start Time
    pattern: "(^([0-9]|[0-1][0-9]|[2][0-3]):([0-5][0-9])$)|(^([0-9]|[1][0-9]|[2][0-3])$)"

################################################
## Input Selectors
################################################
input_select:
  wakeup_nerene_light:
    name: Wakeup Light
    icon: mdi:lightbulb
    options:
      - light.nerenes_light
      #- light.3a76dc
      - light.nerenes_light
      - light.garage_entry_light

################################################
## Sliders
################################################
input_number:
  wakeup_nerene_hour:
    name: Hour
    icon: mdi:timer
    mode: slider
    min: 0
    max: 23
    step: 1

  wakeup_nerene_minutes:
    name: Minutes
    icon: mdi:clock-outline
    mode: slider
    min: 0
    max: 59
    #step: 5
    step: 1

################################################
## Sensors
################################################
sensor:
  - platform: template
    sensors:
      wakeup_nerene_time:
        friendly_name: "Alarm"
        icon_template: mdi:clock-outline
        value_template: >-
          {% set wakeup_nerene_time = "%0.02d:%0.02d" | format(states('input_number.wakeup_nerene_hour')|int, states('input_number.wakeup_nerene_minutes')|int) %}
          {{ wakeup_nerene_time | timestamp_custom('%H:%M', false) }}

      wakeup_nerene_day_label:
        friendly_name: "Select days:"
        icon_template: mdi:calendar-range
        value_template: ""

################################################
## Switches
################################################
input_boolean:
  wakeup_nerene_status:
    name: Activate Alarm
    icon: mdi:alarm-check

  wakeup_nerene_mon:
    name: Monday
    icon: mdi:blank
  wakeup_nerene_tue:
    name: Tuesday
    icon: mdi:blank
  wakeup_nerene_wed:
    name: Wednesday
    icon: mdi:blank
  wakeup_nerene_thu:
    name: Thursday
    icon: mdi:blank
  wakeup_nerene_fri:
    name: Friday
    icon: mdi:blank
  wakeup_nerene_sat:
    name: Saturday
    icon: mdi:blank
  wakeup_nerene_sun:
    name: Sunday
    icon: mdi:blank

################################################
## Scenes
################################################
scene:
  - name: Nerene Wake Up
    entities:
      light.entry_light:
        state: on
        brightness_pct: '40'
      light.kitchen_undercabinet:
        state: on
        brightness_pct: '100'

################################################
## Scripts
################################################
script:
  wakeup_nerene_activate:
    sequence:
    - service: script.turn_on
      entity_id: script.wakeup_nerene_light_fade
    - service: scene.turn_on
      entity_id: scene.nerene_wake_up
    #- delay: 00:10:00
    #- service: script.turn_on
    #  entity_id: script.wakeup_nerene_ios_alarm

  wakeup_nerene_ios_alarm:
    sequence:
    - service: notify.nerene
      data:
        title: "Alarm Clock"
        message: "It's Time For You To Wake Up!"
        data:
          push:
            sound: "US-EN-Alexa-Good-Morning.wav"
            badge: 0
            category: 'alarmclock'

  wakeup_nerene_light_fade:
    sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.bedroom_light_sync_enabled
    # - service: python_script.lightfade
    #   data_template:
    #     # Go from 10%-100% up 2% every 13 seconds 
    #     # to go to full brightness in about 10 minutes.
    #     entity_id: "{{ states('input_select.wakeup_nerene_light') }}"
    #     delay_in_sec: 13
    #     start_level_pct: 10
    #     end_level_pct: 100
    #     step_in_level_pct: 2
    - service: homeassistant.turn_on
      data_template:
        entity_id: "{{ states('input_select.wakeup_nerene_light') }}"

################################################
## Automations
################################################
automation:
  - alias: "Alarm Clock: Nerene"
    trigger:
      platform: template
      value_template: "{{ states('sensor.time')|timestamp_custom('%H:%M', false) == states('sensor.wakeup_nerene_time')|timestamp_custom('%H:%M', false) }}"
    condition:
      condition: and
      conditions:
        #  - condition: state
        #    entity_id: device_tracker.nerene
        #    state: home
        - condition: state
          entity_id: input_boolean.wakeup_nerene_status
          state: 'on'
        # Is today one of the selected days?
        - condition: template
          value_template: >
            {% set   day_name = now().strftime("%A")|lower -%}
            {%- if   day_name == 'monday'    and states.input_boolean.wakeup_nerene_mon.state == 'on' -%}{{true}}
            {%- elif day_name == 'tuesday'   and states.input_boolean.wakeup_nerene_tue.state == 'on' -%}{{true}}
            {%- elif day_name == 'wednesday' and states.input_boolean.wakeup_nerene_wed.state == 'on' -%}{{true}}
            {%- elif day_name == 'thursday'  and states.input_boolean.wakeup_nerene_thu.state == 'on' -%}{{true}}
            {%- elif day_name == 'friday'    and states.input_boolean.wakeup_nerene_fri.state == 'on' -%}{{true}}
            {%- elif day_name == 'saturday'  and states.input_boolean.wakeup_nerene_sat.state == 'on' -%}{{true}}
            {%- elif day_name == 'sunday'    and states.input_boolean.wakeup_nerene_sun.state == 'on' -%}{{true}}
            {%- else -%}{{false}}{%- endif %}
    action:
      service: script.turn_on
      entity_id: script.wakeup_nerene_activate

  # Start Time storage and recall.
  - alias: "Alarm Clock: Nerene Start Time Changes"
    trigger:
      platform: state
      entity_id:
        - input_datetime.wakeup_nerene_hour
        - input_datetime.wakeup_nerene_minutes
    action:
      - service: homeassistant.update_entity
        entity_id: sensor.wakeup_nerene_time