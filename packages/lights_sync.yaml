################################################
## Automation
################################################
automation:
  ##############################################
  ## Bed Room Light Automations
  ##############################################
  ## Turn the lamp off when the main switch is turned off.
  - alias: Bed Room Light Off
    trigger:
      - platform: state
        entity_id: light.nerenes_light
        from: 'on'
        to: 'off'
    action:
      - service: light.turn_off
        entity_id: light.3a76dc #light.brians_light
  
  - alias: Bed Room Light lt 75pct
    trigger:
      - platform: numeric_state
        entity_id: light.nerenes_light
        value_template: '{{ state.attributes.brightness }}'
        below: '190' # slightly less than 75%
    action:
      - service: light.turn_off
        entity_id: light.3a76dc #light.brians_light

  - alias: Bed Room Light gte 75pct
    trigger:
      - platform: numeric_state
        entity_id: light.nerenes_light
        value_template: '{{ state.attributes.brightness }}'
        above: '190'
        # Delay to avoid premature turn on flash.
        for:
          seconds: 2
    condition:
      - condition: state
        entity_id: input_boolean.bedroom_light_sync_enabled
        state: 'on'
    action:
      - service: light.turn_on
        entity_id: light.3a76dc #light.brians_light
 
  # This should only stay off long enough for the bedroom light to fade to 100%.
  - alias: Bed Room Light Sync is Switched Off
    trigger:
      platform: state
      entity_id: input_boolean.bedroom_light_sync_enabled
      from: 'on'
      to: 'off'
      for:
        minutes: 15
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.bedroom_light_sync_enabled

  ##############################################
  ## Family Room Light Automations
  ##############################################
  ## Turn the table lamp off when the main switch is turned off.
  - alias: Family Room Light Off
    trigger:
      - platform: state
        entity_id: light.family_room_light
        from: 'on'
        to: 'off'
    action:
      - service: light.turn_off
        entity_id: light.3a5e44

  - alias: Family Room Light lt 75pct
    trigger:
      - platform: numeric_state
        entity_id: light.family_room_light
        value_template: '{{ state.attributes.brightness }}'
        below: '190' # slightly less than 75%
    action:
      - service: light.turn_off
        entity_id: light.3a5e44

  - alias: Family Room Light gte 75pct
    trigger:
      - platform: numeric_state
        entity_id: light.family_room_light
        value_template: '{{ state.attributes.brightness }}'
        above: '190'
        # Delay to avoid premature turn on flash.
        for:
          seconds: 1
    action:
      - service: light.turn_on
        entity_id: light.3a5e44

  ##############################################
  ## Kitchen Light Automations
  ##############################################
  # Set the kitchen cabinet lights to full brightness when 
  # the overhead lights turn off.
  - alias: Kitchen Lights Off
    trigger:
      - platform: template
        value_template: "{% if is_state('switch.kitchen_light', 'off') 
                           and is_state('switch.kitchen_prep_light', 'off') %}true{% endif %}"
    condition:
      - condition: state
        entity_id: light.kitchen_undercabinet
        state: 'on'
    action:
      - service: light.turn_on
        data_template:
          entity_id: light.kitchen_undercabinet
          brightness: >-
            {% if is_state('sun.sun' , 'above_horizon') -%}
              254
            {% else -%}
              63
            {% endif -%}

  # Set the kitchen cabinet lights to full brightness when 
  # the overhead lights turn on.
  - alias: Kitchen Lights On
    trigger:
      - platform: state
        entity_id:
          - switch.kitchen_light
          - switch.kitchen_prep_light
        to: 'on'
    condition:
      - condition: state
        entity_id: light.kitchen_undercabinet
        state: 'on'
    action:
      - service: light.turn_on
        data:
          entity_id: light.kitchen_undercabinet
          brightness: 254

  # Reset the kitchen cabinet lights to warm white light, 
  # and adjust the brightness based on the defined conditions.
  - alias: Kitchen Cabinet Lights On
    trigger:
       - platform: state
         entity_id: light.kitchen_undercabinet
         from: 'off'
         to: 'on'
    action:
      - service: light.turn_on
        data_template:
          entity_id: light.kitchen_undercabinet
          color_temp: 200
          brightness: >-
           {% if is_state('sun.sun' , 'above_horizon')
               or is_state('switch.kitchen_light', 'on')
               or is_state('switch.kitchen_prep_light', 'on') -%}
              254
            {% else -%}
              63
            {% endif -%}

  ##############################################
  ## Living Room Light Automations
  ##############################################
  - alias: Living Room Light Turns Off
    trigger:
      - platform: state
        entity_id: light.living_room_light
        from: 'on'
        to: 'off'
    action:
      - service: light.turn_off
        entity_id:  light.3a4f5b #light.living_room_corner_lamp

  - alias: Living Room Light lt 75pct
    trigger:
      - platform: numeric_state
        entity_id: light.living_room_light
        value_template: '{{ state.attributes.brightness }}'
        below: '190'
    action:
      - service: light.turn_off
        entity_id:  light.3a4f5b #light.living_room_corner_lamp
      #- service: input_number.set_value
      #  data:
      #    entity_id: input_number.livingroom_dimmer
      #    value_template: '{{ state.light.living_room_light.attributes.brightness_pct }}'

  - alias: Living Room Light gte 75pct
    trigger:
      - platform: numeric_state
        entity_id: light.living_room_light
        value_template: '{{ state.attributes.brightness }}'
        above: '190'
        # Delay to avoid premature turn on flash.
        for:
          seconds: 1
    action:
      # - service: input_number.set_value
      #  data:
      #    entity_id: input_number.livingroom_corner_dimmer
      #    value: 50
      - service: light.turn_on
        data:
          brightness_pct: '50'
          entity_id:  light.3a4f5b #light.living_room_corner_lamp