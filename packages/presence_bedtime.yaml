homeassistant:
  customize:
    binary_sensor.brians_bed_occupancy:
      device_class: occupancy
    binary_sensor.nerenes_bed_occupancy:
      device_class: occupancy

################################################
## Automation Switches
################################################
input_boolean:
  brians_bed_occupancy:
    initial: "off"
  nerenes_bed_occupancy:
    initial: "off"

################################################
## Sensors
################################################
binary_sensor:
  - platform: template
    sensors:
      brians_bed_occupancy:
        value_template: "{{ states.input_boolean.brians_bed_occupancy.state == 'true' }}"
        device_class: presence
        friendly_name: "Brian's Bed Presence"
        icon_template: mdi:hotel

  - platform: template
    sensors:
      nerenes_bed_occupancy:
        value_template: "{{ states.input_boolean.nerenes_bed_occupancy.state == 'true' }}"
        device_class: presence
        friendly_name: "Nerene's Bed Presence"
        icon_template: mdi:hotel
  
  - platform: template
    sensors:
      brian_charge_state:
        value_template: "{{ states.device_tracker.brian.attributes.battery_charging }}"
        device_class: plug
        friendly_name: "Brian's Phone Charge State"
        icon_template: mdi:hotel

  - platform: template
    sensors:
      nerene_charge_state:
        value_template: "{{ states.device_tracker.nerene.attributes.battery_charging }}"
        device_class: plug
        friendly_name: "Nerene's Phone Charge State"
        icon_template: mdi:hotel

################################################
## Automation
################################################
automation:
  ## Bedtime Start
  - alias: "Bedtime Start: Brian"
    trigger:
      - platform: state
        entity_id: binary_sensor.brian_charge_state
        from: 'off'
        to: 'on'
        for:
          minutes: 05
          seconds: 00
    condition:
      # between 9pm-6am
      - condition: time
        after: '21:00:00'
        before: '06:00:00'
      # Brian is home
      - condition: state
        entity_id: device_tracker.brian
        state: 'home'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.brians_bed_occupancy

  - alias: "Bedtime Start: Nerene"
    trigger:
      - platform: state
        entity_id: binary_sensor.nerene_charge_state
        from: 'off'
        to: 'on'
        for:
          minutes: 05
          seconds: 00
    condition:
      # between 9pm-6am
      - condition: time
        after: '21:00:00'
        before: '06:00:00'
      # Nerene is home
      - condition: state
        entity_id: device_tracker.nerene
        state: 'home'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.nerenes_bed_occupancy

  ## Bedtime End
  - alias: "Bedtime End: Brian"
    trigger:
      - platform: state
        entity_id: binary_sensor.brian_charge_state
        to: 'off'
        for:
          minutes: 01
          seconds: 00
    condition:
      # Brian is home
      - condition: state
        entity_id: device_tracker.brian
        state: 'home'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.brians_bed_occupancy

  ## Bedtime End
  - alias: "Bedtime End: Nerene"
    trigger:
      - platform: state
        entity_id: binary_sensor.nerene_charge_state
        to: 'off'
        for:
          minutes: 01
          seconds: 00
    condition:
      # Nerene is home
      - condition: state
        entity_id: device_tracker.nerene
        state: 'home'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.nerenes_bed_occupancy