homeassistant:
  customize:
    sensor.holiday:
      hidden: true
      icon: mdi:beach
      friendly_name: US Holiday
    sensor.flag:
      hidden: true
      icon: mdi:flag
      friendly_name: Flag Day

###############################################################################
# Sensor updates once every 4 hours (14400 seconds) & runs 6 times in 24 hours
#
# First it checks for holiday in static section, if that doesn't exist,
# it checks in the dynamic section. If neither exists, the value will be empty
###############################################################################
sensor:
  - platform: rest
    resource: https://raw.githubusercontent.com/brianhanifin/Home-AssistantConfig/master/json_data/holidays.json
    name: Holiday
    scan_interval: 14400
    value_template: >
      {% set today = now().month  ~ '/' ~ now().day  -%}
      {%- set personal = value_json.PERSONAL[ today ]|trim -%}
      {%- set holiday = value_json.MAJOR_US.static[ today ]|trim -%}
      {%- if holiday == "" -%}
        {%- set today = now().month  ~ '/' ~ now().day ~ '/' ~ now().year -%}
        {%- set holiday = value_json.MAJOR_US.dynamic[ today ]|trim -%}
      {%- endif -%}
      {%- if personal != '' -%}
        {{ personal }}
        {%- if holiday != '' -%}{{ ' and ' }}{%- endif -%}
      {%- endif -%}
      {{ holiday }}

  - platform: rest
    resource: http://www.webcal.fi/cal.php?id=335&format=json&start_year=current_year&end_year=2018&tz=America%2FLos_Angeles
    name: Flag
    scan_interval: 14400
    value_template: >-
      {% set is_flag_day = False -%}
      {%- for day_val in value_json -%}
        {% set now_string = now().strftime('%Y-%m-%d') -%}
        {%- if day_val.date == now_string and day_val.flag_day == 1 -%}
          {%- set is_flag_day = True -%}
        {%- endif -%}
      {%- endfor %}
      {{is_flag_day}}

  - platform: template
    sensors:
      holiday_scene:
        value_template: >
          {% set holiday_scene = states('sensor.holiday') -%}
          {%- if  holiday_scene is not none
              and holiday_scene != "" -%}
            {%- set holiday_scene = holiday_scene|lower|trim|replace("'","")|replace(" ","_")|replace("eve","day") -%}
            {%- set holiday_scene = holiday_scene|replace("mothers_day","valentine")|replace("earth_day","st_patty") -%}
            {%- if holiday_scene.split('_')|last == 'birthday' -%}{%- set holiday_scene = "birthday" -%}{%- endif %}
            {{ holiday_scene }}
          {%- else -%}
            {{ "standard" }}
          {%- endif %}

###############################################################################
# Automation notifies of a Holiday "state" change & starts light scene.
###############################################################################
automation:
  - alias: On Holiday State Change
    hide_entity: false
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - sensor.holiday
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state is not none
                        and trigger.to_state.state|trim != 'unknown'
                        and trigger.to_state.state|trim != '' }}"
    action:
      - service: script.notify_ios_engine
        data_template:
          title: '{{ trigger.to_state.state }}'
          message: 'Today is {{ trigger.to_state.state }}.'
      - service: scene.turn_on
        data_template:
          entity_id: 'scene.month_{{ states(sensor.holiday_scene) }}_colors'