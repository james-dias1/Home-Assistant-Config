# Original: @mf-social https://github.com/mf-social/Home-Assistant/blob/master/packages/virtual_devices/alarm_clocks/
homeassistant:
  customize:
    input_boolean.brian_alarm_clock_status:
      persistent: true
    input_number.brian_alarm_clock_hour:
      persistent: true
    input_number.brian_alarm_clock_minutes:
      persistent: true
    input_select.brian_alarm_clock_light:
      persistent: true
    input_boolean.brian_alarm_clock_mon:
      persistent: true
    input_boolean.brian_alarm_clock_tue:
      persistent: true
    input_boolean.brian_alarm_clock_wed:
      persistent: true
    input_boolean.brian_alarm_clock_thu:
      persistent: true
    input_boolean.brian_alarm_clock_fri:
      persistent: true
    input_boolean.brian_alarm_clock_sat:
      persistent: true
    input_boolean.brian_alarm_clock_sun:
      persistent: true
    sensor.brian_alarm_clock_light:
      persistent: true
      state_card_mode: none
    sensor.brian_alarm_clock_day_label:
      state_card_mode: none

################################################
## Group
################################################
group:
  brian_alarm_clock:
    name: "Brian's Wakeup Light"
    entities:
      - input_boolean.brian_alarm_clock_status
      - input_number.brian_alarm_clock_hour
      - input_number.brian_alarm_clock_minutes
      - input_select.brian_alarm_clock_light
      - sensor.brian_alarm_clock_day_label
      - input_boolean.brian_alarm_clock_mon
      - input_boolean.brian_alarm_clock_tue
      - input_boolean.brian_alarm_clock_wed
      - input_boolean.brian_alarm_clock_thu
      - input_boolean.brian_alarm_clock_fri
      - input_boolean.brian_alarm_clock_sat
      - input_boolean.brian_alarm_clock_sun

      #- sensor.time
      #- sensor.nerene_alarm_clock_time
      #- sensor.nerene_alarm_clock_light
    control: hidden
    view: no

################################################
## Input Selectors
################################################
input_select:
  brian_alarm_clock_light:
    name: Wakeup Light
    icon: mdi:lightbulb
    options:
      - light.bedroom_light
      - light.brians_light
      #- light.garage_entry_light

################################################
## Sliders
################################################
input_number:
  brian_alarm_clock_hour:
    name: Hour
    icon: mdi:timer
    mode: slider
    min: 0
    max: 23
    step: 1

  brian_alarm_clock_minutes:
    name: Minutes
    icon: mdi:clock-outline
    mode: slider
    min: 0
    max: 59
    #step: 5
    step: 1

################################################
## Sensors
################################################
sensor:
  - platform: template
    sensors:
      brian_alarm_clock_time:
        friendly_name: "Alarm"
        icon_template: mdi:clock-outline
        value_template: >-
          {% set brian_alarm_clock_time = "%0.02d:%0.02d" | format(states('input_number.brian_alarm_clock_hour')|int, states('input_number.brian_alarm_clock_minutes')|int) %}
          {{ brian_alarm_clock_time | timestamp_custom('%H:%M', false) }}
      
      brian_alarm_clock_day_label:
        friendly_name: "Select days:"
        icon_template: mdi:calendar-range
        value_template: ""

################################################
## Switches
################################################
input_boolean:
  brian_alarm_clock_status:
    name: Activate Alarm
    icon: mdi:alarm-check

  brian_alarm_clock_mon:
    name: Monday
    icon: mdi:blank
  brian_alarm_clock_tue:
    name: Tuesday
    icon: mdi:blank
  brian_alarm_clock_wed:
    name: Wednesday
    icon: mdi:blank
  brian_alarm_clock_thu:
    name: Thursday
    icon: mdi:blank
  brian_alarm_clock_fri:
    name: Friday
    icon: mdi:blank
  brian_alarm_clock_sat:
    name: Saturday
    icon: mdi:blank
  brian_alarm_clock_sun:
    name: Sunday
    icon: mdi:blank

################################################
## Scenes
################################################
scene:
  - name: brian Wake Up
    entities:
      light.entry_light:
        state: on
        brightness_pct: '40'
      light.kitchen_sink_light: on
      light.garage_entry_light:
        state: on
        brightness_pct: '5'

################################################
## Scripts
################################################
script:
  brian_alarm_clock_activate:
    sequence:
    - service: script.turn_on
      entity_id: script.brian_alarm_clock_light_fade
    #- service: scene.turn_on
    #  entity_id: scene.brian_wake_up
    #- delay: 00:10:00
    #- service: script.turn_on
    #  entity_id: script.brian_alarm_clock_ios_alarm
    #- delay: 00:30:00
    #  service: light.turn_off
    #  entity_id: light.kitchen_sink_light

  brian_alarm_clock_ios_alarm:
    sequence:
    - service: notify.brian
      data:
        title: "Alarm Clock"
        message: "It's Time For You To Wake Up!"
        data:
          push:
            sound: "US-EN-Alexa-Good-Morning.wav"
            badge: 0
            category: 'alarmclock'

  brian_alarm_clock_light_fade:
    sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.bedroom_light_sync_enabled
    - service: python_script.lightfade
      data_template:
        # Go from 10%-100% up 2% every 13 seconds 
        # to go to full brightness in about 10 minutes.
        entity_id: "{{ states('input_select.brian_alarm_clock_light') }}"
        delay_in_sec: 13
        start_level_pct: 10
        end_level_pct: 100
        step_in_level_pct: 2

################################################
## Automations
################################################
automation:
  alias: "Alarm Clock: brian"
  trigger:
    platform: template
    value_template: "{{ states('sensor.time')|timestamp_custom('%H:%M', false) == states('sensor.brian_alarm_clock_time')|timestamp_custom('%H:%M', false) }}"
  condition:
    condition: and
    conditions:
      #  - condition: state
      #    entity_id: device_tracker.brian
      #    state: home
      - condition: state
        entity_id: input_boolean.brian_alarm_clock_status
        state: 'on'
      # Is today one of the selected days?
      - condition: template
        value_template: >
          {% if now().day == 0 and states.input_boolean.brian_alarm_clock_mon.state == 'on' %}{{true}}
          {% elif now().day == 1 and states.input_boolean.brian_alarm_clock_tue.state == 'on' %}{{true}}
          {% elif now().day == 2 and states.input_boolean.brian_alarm_clock_wed.state == 'on' %}{{true}}
          {% elif now().day == 3 and states.input_boolean.brian_alarm_clock_thu.state == 'on' %}{{true}}
          {% elif now().day == 4 and states.input_boolean.brian_alarm_clock_fri.state == 'on' %}{{true}}
          {% elif now().day == 5 and states.input_boolean.brian_alarm_clock_sat.state == 'on' %}{{true}}
          {% elif now().day == 6 and states.input_boolean.brian_alarm_clock_sun.state == 'on' %}{{true}}
          {% else %}{{false}}{% endif %}
  action:
    service: script.turn_on
    entity_id: script.brian_alarm_clock_activate


#          {% set i = 0 %}
#          {% if input_boolean.brian_alarm_clock_mon %}{% if i > 0 %}, {% endif %}mon{% set i = i + 1 %}{% endif %}
#          {% if input_boolean.brian_alarm_clock_tue %}{% if i > 0 %}, {% endif %}tue{% set i = i + 1 %}{% endif %}
#          {% if input_boolean.brian_alarm_clock_wed %}{% if i > 0 %}, {% endif %}wed{% set i = i + 1 %}{% endif %}
#          {% if input_boolean.brian_alarm_clock_thu %}{% if i > 0 %}, {% endif %}thu{% set i = i + 1 %}{% endif %}
#          {% if input_boolean.brian_alarm_clock_fri %}{% if i > 0 %}, {% endif %}fri{% set i = i + 1 %}{% endif %}
#          {% if input_boolean.brian_alarm_clock_sat %}{% if i > 0 %}, {% endif %}sat{% set i = i + 1 %}{% endif %}
#          {% if input_boolean.brian_alarm_clock_sun %}{% if i > 0 %}, {% endif %}sun{% set i = i + 1 %}{% endif %}