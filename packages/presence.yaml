homeassistant:
  customize:
    ##### Brian's Devices
    device_tracker.brian:
      friendly_name: "Brian"
      device_class: presence
    device_tracker.brian_bluetooth:
      friendly_name: "Brian's Phone"
      device_class: connectivity
    devices.automatic:
      friendly_name: "Brian's Car"
      device_class: connectivity

    ##### Nerene's Devices
    device_tracker.nerene:
      friendly_name: "Nerene"
      device_class: presence
    device_tracker.parrot_ck3100:
      friendly_name: "Nerene's Car"
      device_class: connectivity
    
    ##### Guest Devices
    device_tracker.cindy:
      device_class: presence
    device_tracker.eric:
      device_class: presence
    device_tracker.heather:
      device_class: presence
    device_tracker.melissa:
      device_class: presence
    device_tracker.sandy:
      device_class: presence

    ##### Mode toggles
    input_boolean.away_mode:
      persistent: true
    input_boolean.guest_mode:
      persistent: true
    input_boolean.school_mode:
      persistent: true

################################################
## Component Settings
################################################
device_tracker:
  - platform: bluetooth_tracker

  - platform: nmap_tracker
    hosts:
      - 10.0.0.10   # Brian's iPhone
      - 10.0.0.11   # Nerene's iPhone
      #- 10.0.0.0/24
      - 10.0.0.100-254
    new_device_defaults:
      track_new_devices: false
      hide_if_away: true

  #- platform: unifi
  #  host: 10.0.0.56
  #  username: !secret unifi_controller_user
  #  password: !secret unifi_controller_pass
    #ssid_filter:
    #  - !secret unifi_controller_ssid
  #  new_device_defaults:
  #    track_new_devices: false
  #    hide_if_away: true

################################################
## Sensors
################################################
binary_sensor:
  - platform: template
    sensors:
      presence_brian:
        value_template: "{{ is_state('device_tracker.brian', 'home') }}"
        device_class: presence
        friendly_name: Brian

  - platform: template
    sensors:
      presence_family:
        value_template: "{{ is_state('group.family', 'home') }}"
        device_class: presence
        friendly_name: Family

  - platform: template
    sensors:
      presence_guests:
        value_template: "{{ is_state('group.guests', 'home') }}"
        device_class: presence
        friendly_name: Guests

  - platform: template
    sensors:
      presence_nerene:
        value_template: "{{ is_state('device_tracker.nerene', 'home') }}"
        device_class: presence
        friendly_name: Nerene

################################################
## Switches
################################################
input_boolean:
  away_mode:
    name: Away Mode
    icon: mdi:car-estate

  guest_mode:
    name: Guest Mode
    icon: mdi:account-alert

  school_mode:
    name: School Mode
    icon: mdi:school

################################################
## Groups
################################################
group:
  family:
    entities:
      - device_tracker.brian
      - device_tracker.nerene
    name: "Any Family At Home?"
    icon: mdi:home-heart
    view: no

  guests:
    entities:
      - device_tracker.cindy
      - device_tracker.eric
      - device_tracker.heather
      - device_tracker.melissa
      - device_tracker.sandy
    name: "Any Guests At Home?"
    icon: mdi:account-alert
    view: no

################################################
## Scenes
################################################
scene:
  - name: Goodbye
    entities:
      group.goodbye_devices: off

  - name: Good Night
    entities:
      group.goodnight_devices: off

################################################
## Automation
################################################
automation:
  ##############################################################################
  ###  Away Mode State Change
  ##############################################################################
  - alias: "Away Mode: At Home"
    trigger:
      - platform: state
        entity_id: input_boolean.away_mode
        from: "on"
        to: "off"
    action:
      - service: script.turn_on
        entity_id: script.ecobee_resume_normal_operation
      - service: input_boolean.turn_on
        entity_id: input_boolean.motion_detection_mode

  - alias: "Away Mode: Left Home"
    trigger:
      - platform: state
        entity_id: input_boolean.away_mode
        from: "off"
        to: "on"
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.motion_detection_mode
      - service: scene.turn_on
        entity_id: scene.goodbye
      - service: script.turn_on
        entity_id: script.ecobee_temporary_away

  ##############################################################################
  ###  Family Presence Detection
  ##############################################################################
  - alias: Arrive at Home
    trigger:
      - platform: state
        entity_id:
          - device_tracker.brian
          - device_tracker.nerene
          - device_tracker.kyle
          - device_tracker.lucas
          - device_tracker.cindy
          - device_tracker.eric
          - device_tracker.heather
          - device_tracker.melissa
          - device_tracker.sandy
        from: 'not_home'
        to: 'home'
        for:
          minutes: 0
          seconds: 5
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.away_mode
      # Greet the arriving person after they close the garage door.
      #- wait_template: "{{ states.binary_sensor.garage_door.state == 'closed' }}"
      #  timeout: '00:05:00'
      - delay:
          minutes: 2
      - service: script.speech_engine
        data_template:
          call_do_not_greet: 1
          personarriving: >
            {{ trigger.entity_id.split('.')[1]|replace('_', ' ') }}
          call_inside_weather: 1
          call_garage_check: 1
          call_window_check: 1
          call_door_check: 1
          call_light_check: 1
          call_moon: 1

  - alias: Leave home
    trigger:
      - platform: state
        entity_id: group.family
        from: 'home'
        to: 'not_home'
        for:
          minutes: 2
          seconds: 0
    condition:
      # Only turn on Away Mode if no guests are present and the guest mode override is off.
      - condition: template
        value_template: "{{ states.group.guests.state == 'not_home' 
                        and states.input_boolean.guest_mode.state == 'off' }}"
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.away_mode

  ##############################################################################
  ###  Known Guests Presence Detection
  ##############################################################################
  - alias: Known Guests Arrive
    trigger:
      - platform: state
        entity_id: group.guests
        from: 'not_home'
        to: 'home'
        for:
          minutes: 0
          seconds: 5
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.away_mode

  - alias: Known Guests Leave
    trigger:
      - platform: state
        entity_id: group.guests
        from: 'home'
        to: 'not_home'
        for:
          minutes: 2
          seconds: 0
    action:
      # Only turn on Away Mode if no family is present and the guest mode override is off.
      - condition: template
        value_template: "{{ states.group.family.state == 'not_home' 
                        and states.input_boolean.guest_mode.state == 'off' }}"
      - service: input_boolean.turn_on
        entity_id: input_boolean.away_mode