homeassistant:
  customize:
    ##### Brian's Devices
    # Composite device tracker group
    device_tracker.brian:
      friendly_name: "Brian"
      device_class: presence
    # Home Assistant iOS App
    device_tracker.brians_iphone:
      friendly_name: "Brian's iPhone"
      device_class: presence
    # Local Device Pings
    device_tracker.brians_iphone_bluetooth:
      friendly_name: "Brian's iPhone"
      device_class: connectivity
    device_tracker.brians_iphone_nmap:
      friendly_name: "Brian's iPhone"
      device_class: connectivity
    # Life360 iOS App
    device_tracker.life360_brian:
      friendly_name: "Brian's iPhone"
      device_class: presence
    # Car Bluetooth Devices
    device_tracker.automatic:
      friendly_name: "Brian's Car"
      device_class: connectivity

    ##### Nerene's Devices
    # Composite device tracker group
    device_tracker.nerene:
      friendly_name: "Nerene"
      device_class: presence
    # Home Assistant iOS App
    device_tracker.nerenes_iphone:
      friendly_name: "Nerene's iPhone"
      device_class: presence
    # Local Device Pings
    device_tracker.nerenes_iphone_bluetooth:
      friendly_name: "Nerene's iPhone"
      device_class: connectivity
    device_tracker.nerenes_iphone_nmap:
      friendly_name: "Nerene's iPhone"
      device_class: connectivity
    # Life360 iOS App
    device_tracker.life360_nerene:
      friendly_name: "Nerene's iPhone"
      device_class: presence
    # Car Bluetooth Devices
    device_tracker.parrot_ck3100:
      friendly_name: "Nerene's Car"
      device_class: connectivity
    
    ##### Other Family Devices
    device_tracker.cindy:
      device_class: presence
    device_tracker.eric:
      device_class: presence
    device_tracker.heather:
      device_class: presence
    device_tracker.melissa:
      device_class: presence
    device_tracker.sandy:
      device_class: presence

    ##### Mode toggles
    input_boolean.away_mode:
      persistent: true
    input_boolean.guest_mode:
      persistent: true

################################################
## Component Settings
################################################
device_tracker:
  - platform: bluetooth_tracker

  - platform: life360
    username: !secret email1
    password: !secret life360_pass
    prefix: life360
    show_as_state: driving, moving, places
    driving_speed: 18
    max_gps_accuracy: 200
    max_update_wait:
      minutes: 45

  - platform: nmap_tracker
    hosts:
      - 10.0.0.10   # Brian's iPhone
      - 10.0.0.11   # Nerene's iPhone
      #- 10.0.0.0/24
      - 10.0.0.100-254
    new_device_defaults:
      track_new_devices: false
      hide_if_away: true

  #- platform: unifi
  #  host: 10.0.0.56
  #  username: !secret unifi_controller_user
  #  password: !secret unifi_controller_pass
    #ssid_filter:
    #  - !secret unifi_controller_ssid
  #  new_device_defaults:
  #    track_new_devices: false
  #    hide_if_away: true

  ## Device Tracker Smart "Groups"
  - platform: composite
    name: brian
    entity_id:
      #- device_tracker.brians_iphone
      - device_tracker.brians_iphone_bluetooth
      - device_tracker.brians_iphone_nmap
      - device_tracker.life360_brian

  - platform: composite
    name: family_phone
    entity_id:
      - device_tracker.family_phone_bluetooth
      - device_tracker.family_phone_nmap
      - device_tracker.life360_family_phone

  - platform: composite
    name: nerene
    entity_id:
      #- device_tracker.nerenes_iphone
      - device_tracker.nerenes_iphone_bluetooth
      - device_tracker.nerenes_iphone_nmap
      - device_tracker.life360_nerene

################################################
## Switches
################################################
input_boolean:
  away_mode:
    name: Away Mode
    icon: mdi:car-estate

  guest_mode:
    name: Guest Mode
    icon: mdi:account-alert

################################################
## Groups
################################################
group:
  family:
    entities:
      - device_tracker.brian
      - device_tracker.nerene
      - device_tracker.kyle
      - device_tracker.lucas
      - device_tracker.cindy
      - device_tracker.eric
      - device_tracker.heather
      - device_tracker.melissa
      - device_tracker.sandy
    name: "Who's at home?"
    icon: mdi:home-heart
    view: no

################################################
## Scenes
################################################
scene:
  - name: Goodbye
    entities:
      group.goodbye_devices: off

  - name: Good Night
    entities:
      group.goodnight_devices: off

script:
  goodbye_routine:
    sequence:
      # Run the shutdown/goodbye routine.
      - service: script.turn_on
        entity_id: script.shutdown_routine

      - service: script.say
        data_template:
          media_player: "media_player.living_room"
          say_goodbye: "true"

  goodnight_routine:
    sequence:
      # Make sure the garage door is closed.
      - service: cover.close_cover
        entity_id: cover.garage_door
      
      # Run the shutdown/goodbye routine.
      - service: script.turn_on
        entity_id: script.shutdown_routine

      - service: script.say
        data_template:
          media_player: "media_player.kitchen"
          say_goodnight: "true"

  shutdown_routine:
    sequence:
      - service: lock.lock
        entity_id: lock.front_door
      - service: scene.turn_on
        entity_id: scene.good_night

################################################
## Automation
################################################
automation:
  ##############################################################################
  ###  Away Mode State Change
  ##############################################################################
  - alias: "Away Mode: At Home"
    trigger:
      - platform: state
        entity_id: input_boolean.away_mode
        from: "on"
        to: "off"
    action:
      - service: script.turn_on
        entity_id: script.ecobee_resume_normal_operation
      - service: input_boolean.turn_on
        entity_id: input_boolean.motion_detection_mode

  - alias: "Away Mode: Left Home"
    trigger:
      - platform: state
        entity_id: input_boolean.away_mode
        from: "off"
        to: "on"
    action:
      # Make sure the garage door is closed.
      - service: cover.close_cover
        entity_id: cover.garage_door
      
      # Run the shutdown/goodbye routine.
      - service: script.turn_on
        entity_id: script.shutdown_routine

      # Set a few more unnecessary functions to away mode.
      - service: input_boolean.turn_off
        entity_id: input_boolean.motion_detection_mode
      - service: script.turn_on
        entity_id: script.ecobee_temporary_away

  ##############################################################################
  ###  Family Presence Detection
  ##############################################################################
  - alias: Arrive at Home
    trigger:
      - platform: state
        entity_id:
          - device_tracker.brian
          - device_tracker.nerene
          - device_tracker.kyle
          - device_tracker.lucas
          - device_tracker.cindy
          - device_tracker.eric
          - device_tracker.heather
          - device_tracker.melissa
          - device_tracker.sandy
        from: 'not_home'
        to: 'home'
        for:
          minutes: 0
          seconds: 5
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.away_mode
      - delay:
          minutes: 2

      #- service: script.speech_engine
      #  data_template:
      #    call_do_not_greet: 1
      #    personarriving: >
      #      {{ trigger.entity_id.split('.')[1]|replace('_', ' ') }}
      #    call_inside_weather: 1
      #    call_garage_check: 1
      #    call_window_check: 1
      #    call_door_check: 1
      #    call_light_check: 1
      #    call_moon: 1

      - service: script.notify_speech
        data_template:
          media_player: >-
            "media_player.living_room"
          message: >-
            {{ "Welcome home " ~ trigger.entity_id.split('.')[1]|replace('_', ' ') }}

  - alias: Leave home
    trigger:
      - platform: state
        entity_id: group.family
        from: 'home'
        to: 'not_home'
        for:
          minutes: 5
          seconds: 0
    condition:
      # Only turn on Away Mode if no family members are present and the guest mode override is off.
      - condition: template
        value_template: "{{ states.group.family.state == 'not_home'
                        and states.input_boolean.guest_mode.state == 'off' }}"
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.away_mode