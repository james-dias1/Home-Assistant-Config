homeassistant:
  customize:
    ##### Brian's Devices
    device_tracker.brian:
      friendly_name: "Brian"
      device_class: presence
    device_tracker.brian_bluetooth:
      friendly_name: "Brian's Phone"
      device_class: connectivity
    devices.automatic:
      friendly_name: "Brian's Car"
      device_class: connectivity

    ##### Nerene's Devices
    device_tracker.nerene:
      friendly_name: "Nerene"
      device_class: presence
    device_tracker.parrot_ck3100:
      friendly_name: "Nerene's Car"
      device_class: connectivity

    ##### Occupancy Sensors
    binary_sensor.bedroom_occupancy:
      device_class: occupancy
    binary_sensor.home_occupancy:
      device_class: occupancy
    binary_sensor.living_room_occupancy:
      device_class: occupancy
    binary_sensor.lucas_bedroom_occupancy:
      device_class: occupancy

    ##### Motion Sensors
    binary_sensor.kitchen_room_motion:
      friendly_name: "Kitchen"
      device_class: motion
    binary_sensor.play_room_motion:
      friendly_name: "Play Room"
      device_class: motion
    sensor.workbench_motion_detected:
      friendly_name: Workbench
      device_class: motion
    binary_sensor.ring_front_door_motion:
      name: Porch
      device_class: motion


################################################
## Component Settings
################################################
device_tracker:
  #- platform: bluetooth_tracker

  - platform: nmap_tracker
    hosts:
      - 10.0.0.10   # Brian's iPhone
      - 10.0.0.11   # Nerene's iPhone
      #- 10.0.0.0/24
      - 10.0.0.100-254
    new_device_defaults:
      track_new_devices: true #false
      hide_if_away: true

################################################
## Switches
################################################
input_boolean:
  guest_mode:
    name: Guest Mode
    icon: mdi:account-alert
    initial: off

  school_mode:
    name: School Mode
    icon: mdi:school
    #initial: on

################################################
## Groups
################################################
group:
  family:
    entities:
      - device_tracker.brian
      - device_tracker.nerene
    name: "Is Anyone At Home?"
    icon: mdi:home
    view: no

################################################
## Scenes
################################################
scene:
  - name: Goodbye
    entities:
      group.goodbye_devices: off

  - name: Good Night
    entities:
      group.goodnight_devices: off

################################################
## Automation
################################################
automation:
  - alias: Arrive at Home
    trigger:
      - platform: state
        entity_id:
          - device_tracker.brian
          - device_tracker.nerene
        from: 'not_home'
        to: 'home'
    action:
      - service: scene.turn_on
        entity_id: scene.arrive_at_home
      - service: script.turn_on
        entity_id: script.ecobee_resume_normal_operation
      # Greet the arriving person.
      - wait_template: "{{ states.binary_sensor.garage_entry_door.state == 'open' }}"
        timeout: '01:00:00'
      - service: script.speech_engine
        data_template:
          personarriving: >
            {% set person = trigger.entity_id.split('.')[1]|replace('_', ' ')%}
            {%- macro greeting_sentence(person) -%}
            {{ [
            "Welcome back home " ~ person,
            "Guess who is home?" ~ person + " is!",
            person + " is now in the house.",
            "Welcome Home " ~ person + ".  We have missed you. Or at least Buddy and Pepper did.",
            "Our home is now complete, Rest your head and relax your feet! Welcome Back " ~ person,
            "Life is like a song, you’re back where you belong. Welcome home " ~ person,
            "Hey there " ~ person + " Welcome Home!",
            "Knock Knock. Who is There? " ~ person + " is!",
            person ~ "! You are home!",
            "I know a secret! " ~ person + " is home!"
            ] | random }}
            {%- endmacro -%}
            {{greeting_sentence(person)}}
          call_responsibilities: 1
          call_no_announcement: 1
          call_garage_check: 1
          call_window_check: 1

  - alias: Leave home
    trigger:
      - platform: state
        entity_id:
          - device_tracker.brian
          - device_tracker.nerene
        from: 'home'
        to: 'not_home'
        for:
          minutes: 2
    condition:
      - condition: state
        entity_id: input_boolean.guest_mode
        state: 'off'
    action:
      - service: scene.turn_on
        entity_id: scene.goodbye
      - service: script.turn_on
        entity_id: script.ecobee_temporary_away

  ######################################################################
  ##  Some home facts when we get back home from being away.
  ######################################################################
  - alias: 'Home Stats'
    trigger:
      - platform: state
        entity_id: input_boolean.home_stats
        to: 'off'
        from: 'on'
    action:
      - service: script.speech_engine
        data:
          call_inside_weather: 1
          call_responsibilities: 1
          call_outside_weather: 1
          call_garage_check: 1
          call_window_check: 1
          call_light_check: 1
      - service: input_boolean.turn_off
        entity_id: input_boolean.home_stats

  ##############################################################################
  ###  New Device has connected to the network.  let everyone know.
  ##############################################################################
  - alias: "New device connected"
    trigger:
      - platform: event
        event_type: device_tracker_new_device
    action:
      - wait_template: >-
          {{ not is_state('media_player.living_room_speaker', 'playing') }}
      - service: script.speech_engine
        data_template:
          NewDevice: "There has been a new device detected on the network.  Be sure to appropriately catagorize {{trigger.event.data.host_name}} within Circle."

  ######################################################################
  ## Announce when people come or go.
  ## Announce over all Chromecast Audios
  ######################################################################
  #- alias: 'People Greeting'
  #  trigger:
  #    - platform: state
  #      entity_id:
  #        - device_tracker.brian
  #        - device_tracker.nerene
  #      from: 'not_home'
  #      to: 'home'
  #      #for: '00:02:00'
  #  action:
  #    - wait_template: "{{ states.binary_sensor.garage_entry_door.state == 'open' }}"
  #      timeout: '01:00:00'
  #    - service: script.speech_engine
  #      data_template:
  #        personarriving: >
  #          {% set person = trigger.entity_id.split('.')[1]|replace('_', ' ')%}
  #          {%- macro greeting_sentence(person) -%}
  #          {{ [
  #          "Welcome back home " ~ person,
  #          "Guess who is home?" ~ person + " is!",
  #          person + " is now in the house.",
  #          "Welcome Home " ~ person + ".  We have missed you. Or at least Buddy and Pepper did.",
  #          "Our home is now complete, Rest your head and relax your feet! Welcome Back " ~ person,
  #          "Life is like a song, you’re back where you belong. Welcome home " ~ person,
  #          "Hey there " ~ person + " Welcome Home!",
  #          "Knock Knock. Who is There? " ~ person + " is!",
  #          person ~ "! You are home!",
  #          "I know a secret! " ~ person + " is home!"
  #          ] | random }}
  #          {%- endmacro -%}
  #          {{greeting_sentence(person)}}
  #        call_responsibilities: 1
  #        call_no_announcement: 1
  #        call_garage_check: 1
  #        call_window_check: 1