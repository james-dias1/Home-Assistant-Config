homeassistant:
  customize:
    ##### Brian's Devices
    device_tracker.brian:
      friendly_name: "Brian"
      device_class: presence
    device_tracker.brian_bluetooth:
      friendly_name: "Brian's Phone"
      device_class: connectivity
    devices.automatic:
      friendly_name: "Brian's Car"
      device_class: connectivity

    ##### Nerene's Devices
    device_tracker.nerene:
      friendly_name: "Nerene"
      device_class: presence
    device_tracker.parrot_ck3100:
      friendly_name: "Nerene's Car"
      device_class: connectivity
    
    ##### Guest Devices
    device_tracker.cindy:
      device_class: presence
    device_tracker.eric:
      device_class: presence
    device_tracker.heather:
      device_class: presence
    device_tracker.melissa:
      device_class: presence
    device_tracker.sandy:
      device_class: presence

    ##### Mode toggles
    input_boolean.away_mode:
      persistent: true
    input_boolean.guest_mode:
      persistent: true
    input_boolean.school_mode:
      persistent: true

################################################
## Component Settings
################################################
device_tracker:
  #- platform: bluetooth_tracker

  - platform: nmap_tracker
    hosts:
      - 10.0.0.10   # Brian's iPhone
      - 10.0.0.11   # Nerene's iPhone
      #- 10.0.0.0/24
      - 10.0.0.100-254
    new_device_defaults:
      track_new_devices: false
      hide_if_away: true

################################################
## Switches
################################################
input_boolean:
  away_mode:
    name: Away Mode
    icon: mdi:car-estate

  guest_mode:
    name: Guest Mode
    icon: mdi:account-alert

  school_mode:
    name: School Mode
    icon: mdi:school

################################################
## Groups
################################################
group:
  family:
    entities:
      - device_tracker.brian
      - device_tracker.nerene
    name: "Any Family At Home?"
    icon: mdi:home-heart
    view: no

  guests:
    entities:
      - device_tracker.cindy
      - device_tracker.eric
      - device_tracker.heather
      - device_tracker.melissa
      - device_tracker.sandy
    name: "Any Guests At Home?"
    icon: mdi:account-alert
    view: no

################################################
## Scenes
################################################
scene:
  - name: Goodbye
    entities:
      group.goodbye_devices: off

  - name: Good Night
    entities:
      group.goodnight_devices: off

################################################
## Automation
################################################
automation:
  ##############################################################################
  ###  Away Mode State Change
  ##############################################################################
  - alias: "Away Mode: At Home"
    trigger:
      - platform: state
        entity_id: input_boolean.away_mode
        from: "on"
        to: "off"
    action:
      - service: script.turn_on
        entity_id: script.ecobee_resume_normal_operation
      - service: input_boolean.turn_on
        entity_id: input_boolean.motion_detection_mode

  - alias: "Away Mode: Left Home"
    trigger:
      - platform: state
        entity_id: input_boolean.away_mode
        from: "off"
        to: "on"
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.motion_detection_mode
      - service: scene.turn_on
        entity_id: scene.goodbye
      - service: script.turn_on
        entity_id: script.ecobee_temporary_away
 
  ##############################################################################
  ###  Family Presence Detection
  ##############################################################################
  - alias: Arrive at Home
    trigger:
      - platform: state
        entity_id:
          - device_tracker.brian
          - device_tracker.nerene
        from: 'not_home'
        to: 'home'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.away_mode
      
      # Greet the arriving person after they open the garage entry door.
      - wait_template: "{{ states.binary_sensor.garage_entry_door.state == 'open' }}"
        timeout: '01:00:00'
      - service: script.speech_engine
        data_template:
          personarriving: >
            {% set person = trigger.entity_id.split('.')[1]|replace('_', ' ')%}
            {%- macro greeting_sentence(person) -%}
            {{ [
            "Welcome back home " ~ person,
            "Guess who is home?" ~ person + " is!",
            person + " is now in the house.",
            "Welcome Home " ~ person + ".  We have missed you. Or at least Buddy and Pepper did.",
            "Our home is now complete, Rest your head and relax your feet! Welcome Back " ~ person,
            "Life is like a song, youâ€™re back where you belong. Welcome home " ~ person,
            "Hey there " ~ person + " Welcome Home!",
            "Knock Knock. Who is There? " ~ person + " is!",
            person ~ "! You are home!",
            "I know a secret! " ~ person + " is home!"
            ] | random }}
            {%- endmacro -%}
            {{greeting_sentence(person)}}
          call_responsibilities: 1
          call_no_announcement: 1
          call_garage_check: 1
          call_window_check: 1

  - alias: Leave home
    trigger:
      - platform: state
        entity_id: group.family
        from: 'home'
        to: 'not_home'
        for:
          minutes: 2
    condition:
      # Only take action if no known guests are present.
      - condition: state
        entity_id: group.guest
        state: 'not_home'
      # Also don't take action if kids or unknown guests are present (as indicated by Guest Mode Override.
      - condition: state
        entity_id: input_boolean.guest_mode
        state: 'off'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.away_mode


  ##############################################################################
  ###  Known Guests Presence Detection
  ##############################################################################
  - alias: Known Guests Arrive
    trigger:
      - platform: state
        entity_id: group.guests
        from: 'not_home'
        to: 'home'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.away_mode

  - alias: Known Guests Leave
    trigger:
      - platform: state
        entity_id: group.guests
        from: 'home'
        to: 'not_home'
        for:
          minutes: 2
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.away_mode

  ######################################################################
  ##  Some home facts when we get back home from being away.
  ######################################################################
  - alias: 'Home Stats'
    trigger:
      - platform: state
        entity_id:
          - group.family
        from: 'not_home'
        to: 'home'
      - platform: state
        entity_id: input_boolean.home_stats
        to: 'on'
        from: 'off'
    action:
      - wait_template: >-
          {{ is_state('cover.garage_door', 'closed') }}
        timeout: 00:05:30
      - service: script.speech_engine
        data:
          call_inside_weather: 1
          call_responsibilities: 1
          call_outside_weather: 1
          call_garage_check: 1
          call_window_check: 1
          call_light_check: 1

  ##############################################################################
  ###  New Device has connected to the network.  let everyone know.
  ##############################################################################
  - alias: "New device connected"
    trigger:
      - platform: event
        event_type: device_tracker_new_device
    action:
      - wait_template: >-
          {{ not is_state('media_player.living_room_speaker', 'playing') }}
      - service: script.speech_engine
        data_template:
          NewDevice: "There has been a new device detected on the network.  Be sure to appropriately catagorize {{trigger.event.data.host_name}} within Circle."