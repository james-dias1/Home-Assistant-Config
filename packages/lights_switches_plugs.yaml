homeassistant:
  customize:
    switch.entry_step_light:
      homebridge_hidden: true

################################################
## Component Settings
################################################
##### Switches
lutron_caseta:
  host: 10.0.0.52
  keyfile: caseta.key
  certfile: caseta.crt
  ca_certs: caseta-bridge.crt

##### Plugs
insteon_local:
  host: 10.0.0.40
  username: !secret insteon_user
  password: !secret insteon_pass
  timeout: 30

################################################
## Lights
################################################
light:
  - platform: insteon_local

  ## Light Groups
  - platform: group
    name: "Interior Lights"
    entities:
      - light.bedroom_lights
      - light.dining_room_light
      - light.entry_light
      - light.family_room_lights
      - light.living_room_lights

  - platform: group
    name: "Bedroom Lights"
    entities:
      - light.bedroom_light
      - light.brians_light

  - platform: group
    name: "Family Room Lights"
    entities:
      - light.family_room_light
      - light.family_table_lamp

  - platform: group
    name: "Living Room Lights"
    entities:
      - light.living_room_light
      - light.living_corner_lamp

  - platform: group
    name: "Play Room Lights"
    entities:
      - light.play_room_light
      - light.computer_desk_light

  ##############################################
  ## Light Aliases
  ##############################################
  - platform: group
    name: "Bedroom Switch"
    entities:
      - light.bedroom_light

  - platform: group
    name: "Brian's Lamp"
    entities:
      - light.bedroom_light

  - platform: group
    name: "Bryen's Light"
    entities:
      - light.bedroom_light

  - platform: group
    name: "Computer Light"
    entities:
      - light.computer_desk_light

  - platform: group
    name: "Desk Light"
    entities:
      - light.computer_desk_light

  - platform: group
    name: "Family Room Switch"
    entities:
      - light.family_room_light

  - platform: group
    name: "Living Room Switch"
    entities:
      - light.living_room_light

  - platform: group
    name: "Stair Light"
    entities:
      - light.entry_light

################################################
## Groups: Lights & Switches
################################################
group:
  downstairs_lights:
    entities:
      - light.dining_room
      - group.entry_lights
      - light.family_room_lights
      - light.living_room_lights
      - light.play_room_lights
    name: Downstairs Lights
    icon: mdi:wrench
    control: hidden
    view: no

  entry_lights:
    entities:
      - light.entry_light
      - switch.entry_step_light
    name: Entry Lights
    icon: mdi:wrench
    control: hidden
    view: no

  interior_lights:
    entities:
      - light.bedroom_lights
      - light.dining_room
      - group.entry_lights
      - light.family_room_lights
      - light.living_room_lights
      - light.play_room_lights
    name: Interior Lights
    icon: mdi:wrench
    control: hidden
    view: no

  upstairs_lights:
    entities:
      - light.bedroom_lights
    name: Interior Lights
    icon: mdi:wrench
    control: hidden
    view: no

################################################
## Switches
################################################
input_boolean:
  dusk_dimmers_enabled:
    name: Dusk Dimmers
    icon: mdi:weather-sunset
    initial: on

switch:
  platform: insteon_local

################################################
## Sliders
################################################
#input_number:
#  livingroom_dimmer:
#    name: Floor Lamp
#    icon: mdi:lightbulb-on-outline
#    mode: slider
#    initial: 100
#    min: 0
#    max: 100
#    step: 10
#
#  livingroom_corner_dimmer:
#    name: Corner Lamp
#    icon: mdi:lightbulb-on-outline
#    mode: slider
#    initial: 100
#    min: 0
#    max: 100
#    step: 10

################################################
## Scenes
################################################
scene:
  - name: Dusk
    entities:
      light.porch_light: on
      light.entry_light:
        state: on
        transition: 1
        brightness_pct: '60'
      light.nightlight:       # Boys Bathroom Nightlight
        state: on
        transition: 5
        brightness_pct: '30'

  - name: Goodbye
    entities:
      group.goodbye_devices: off

  - name: Good Night
    entities:
      group.goodnight_devices: off

  - name: Morning Devices Off
    entities:
      group.morning_devices: off

################################################
## Scripts
################################################
script:
  dusk_plus_1hr:
    alias: Dusk Plus 1 Hour
    sequence:
      - service: light.turn_on
        data_template:
          entity_id: light.porch_light{% if is_state('light.entry_light', 'on') %}, light.entry_light{% endif %}{% if is_state('light.living_room_light', 'on') %}, light.living_room_light{% endif %}{% if is_state('light.family_room_light', 'on') %}, light.family_room_light{% endif %}
          transition: 10
          brightness_pct: 80

  dusk_plus_15hrs:
    alias: Dusk Plus 1 1/2 Hours
    sequence:
      - service: light.turn_off
        entity_id: 
          - light.living_corner_lamp
          - light.family_table_lamp
      - service: light.turn_on
        data_template:
          entity_id: light.porch_light{% if is_state('light.entry_light', 'on') %}, light.entry_light{% endif %}{% if is_state('light.living_room_light', 'on') %}, light.living_room_light{% endif %}{% if is_state('light.family_room_light', 'on') %}, light.family_room_light{% endif %}
          transition: 10
          brightness_pct: 60

  dusk_plus_2hrs:
    alias: Dusk Plus 2 Hours
    sequence:
      - service: light.turn_off
        entity_id: 
          - light.living_corner_lamp
          - light.family_table_lamp
      - service: light.turn_on
        data_template:
          entity_id: light.porch_light{% if is_state('light.entry_light', 'on') %}, light.entry_light{% endif %}{% if is_state('light.living_room_light', 'on') %}, light.living_room_light{% endif %}{% if is_state('light.family_room_light', 'on') %}, light.family_room_light{% endif %}
          transition: 10
          brightness_pct: 50

  dusk_plus_25hrs:
    alias: Dusk Plus 2 1/2 Hours
    sequence:
      - service: light.turn_off
        entity_id: 
          - light.living_corner_lamp
          - light.family_table_lamp
      - service: light.turn_on
        data_template:
          entity_id: light.porch_light{% if is_state('light.entry_light', 'on') %}, light.entry_light{% endif %}{% if is_state('light.living_room_light', 'on') %}, light.living_room_light{% endif %}{% if is_state('light.family_room_light', 'on') %}, light.family_room_light{% endif %}
          transition: 10
          brightness_pct: 40

  dusk_plus_3hrs:
    alias: Dusk Plus 3 Hours
    sequence:
      - service: light.turn_off
        entity_id: 
          - light.living_corner_lamp
          - light.family_table_lamp
      - service: light.turn_on
        data_template:
          entity_id: light.porch_light{% if is_state('light.entry_light', 'on') %}, light.entry_light{% endif %}{% if is_state('light.living_room_light', 'on') %}, light.living_room_light{% endif %}{% if is_state('light.family_room_light', 'on') %}, light.family_room_light{% endif %}
          transition: 10
          brightness_pct: 30

  set_light_brightness_pct_by_time:
    alias: "Function: Set Light Brightness By Time"
    sequence:
      - service: light.turn_on
        data_template:
          entity_id: "{{ trigger.event.data.entity_id }}"
          brightness_pct: >
            {%- macro brightnessPctByTime() -%}
              {% set hour=states("sensor.time").split(':')[0] | int %}
              {% set minutes=states("sensor.time").split(':')[1] | int %}
              {%- if hour >= 5 and hour < 8  -%}
                60
              {%- elif hour >= 8 and hour < 19  -%}
                100
              {%- elif hour >= 19 and hour < 20 and minutes < 30 -%}
                80
              {%- elif hour >= 19 and hour < 20 and minutes > 30 -%}
                60
              {%- elif hour >= 20 and hour < 21 and minutes < 30 -%}
                50
              {%- elif hour >= 20 and hour < 21 and minutes > 30 -%}
                40
              {%- elif hour >= 21 or hour < 1 -%}
                30
              {%- else -%}
                40
              {%- endif %}
            {%- endmacro -%}
            {{ brightnessPctByTime() }}

  turn_off_interior_lights:
    alias: Turn Off Interior Lights
    sequence:
      - service: homeassistant.turn_off
        entity_id:
          - group.interior_lights

################################################
## Automation
################################################
automation:
  ##############################################
  ## Light brightness adjusts based on time
  ##############################################
  - alias: Adjust light brightness at night
    trigger:
      - platform: event
        event_type: state_changed

    condition:
      # Only adjust light brightness if someone is home and the Dusk Dimmers are enabled.
      - condition: state
        entity_id: binary_sensor.presence_home
        state: 'on'
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'

      # Only look at lights.
      - condition: template
        value_template: "{{ trigger.event.data is not none }}"
      - condition: template
        value_template: "{{ trigger.event.data.entity_id is not none }}"
      - condition: template
        value_template: "{{ trigger.event.data.entity_id.split('.')[0] == 'light' }}"

      # Don't change these lights.
      - condition: template
        value_template: "{{ trigger.event.data.entity_id.split('_')[0] != 'light.living_corner_lamp' }}"
      - condition: template
        value_template: "{{ trigger.event.data.entity_id.split('_')[0] != 'light.family_table_lamp' }}"
      - condition: template
        value_template: "{{ trigger.event.data.entity_id.split('_')[0] != 'light.nightlight' }}"

      # Only when lights are going from off to on.
      - condition: template
        value_template: "{{ trigger.event.data.old_state.state == 'off' }}"
      - condition: template
        value_template: "{{ trigger.event.data.new_state.state == 'on' }}"

    action:
      - service: light.turn_on
        data_template:
          entity_id: "{{ trigger.event.data.entity_id }}"
          brightness_pct: >
            {%- macro brightnessPctByTime() -%}
              {% set hour=states("sensor.time").split(':')[0] | int %}
              {% set minutes=states("sensor.time").split(':')[1] | int %}
              {%- if hour >= 5 and hour < 8  -%}
                60
              {%- elif hour >= 8 and hour < 19  -%}
                100
              {%- elif hour >= 19 and hour < 20 and minutes < 30 -%}
                80
              {%- elif hour >= 19 and hour < 20 and minutes > 30 -%}
                60
              {%- elif hour >= 20 and hour < 21 and minutes < 30 -%}
                50
              {%- elif hour >= 20 and hour < 21 and minutes > 30 -%}
                40
              {%- elif hour >= 21 or hour < 1 -%}
                30
              {%- else -%}
                40
              {%- endif %}
            {%- endmacro -%}
            {{ brightnessPctByTime() }}

  ##############################################
  ## Bed Room Light Automations
  ##############################################
  ## Turn the lamp off when the main switch is turned off.
  - alias: Bed Room Switch Off
    trigger:
      - platform: state
        entity_id: light.bedroom_light
        from: 'on'
        to: 'off'
    action:
      - service: light.turn_off
        data:
          entity_id: light.brians_light
          transition: 10
  
  - alias: Bed Room Switch 0-74%
    trigger:
      - platform: numeric_state
        entity_id: light.bedroom_light
        value_template: '{{ state.attributes.brightness }}'
        below: '190' # slightly less than 75%
    action:
      - service: light.turn_off
        entity_id: light.brians_light

  - alias: Bed Room Switch 75-100%
    trigger:
      - platform: numeric_state
        entity_id: light.bedroom_light
        value_template: '{{ state.attributes.brightness }}'
        above: '190'
        # Delay to avoid premature turn on flash.
        for:
          seconds: 2
    action:
      - service: light.turn_on
        entity_id: light.brians_light

  ##############################################
  ## Family Room Light Automations
  ##############################################
  ## Turn the table lamp off when the main switch is turned off.
  - alias: Family Room Switch Off
    trigger:
      - platform: state
        entity_id: light.family_room_light
        from: 'on'
        to: 'off'
    action:
      - service: light.turn_off
        entity_id: light.family_table_lamp

  - alias: Family Room Switch 0-74%
    trigger:
      - platform: numeric_state
        entity_id: light.family_room_light
        value_template: '{{ state.attributes.brightness }}'
        below: '190' # slightly less than 75%
    action:
      - service: light.turn_off
        entity_id: light.family_table_lamp

  - alias: Family Room Switch 75-100%
    trigger:
      - platform: numeric_state
        entity_id: light.family_room_light
        value_template: '{{ state.attributes.brightness }}'
        above: '190'
        # Delay to avoid premature turn on flash.
        for:
          seconds: 1
    action:
      - service: light.turn_on
        entity_id: light.family_table_lamp

  ##############################################
  ## Living Room Light Automations
  ##############################################
  - alias: Living Room Floor Lamp Turns Off
    trigger:
      - platform: state
        entity_id: light.living_room_light
        from: 'on'
        to: 'off'
    action:
      - service: light.turn_off
        entity_id: light.living_corner_lamp

  - alias: Living Room Floor Lamp 0-74
    trigger:
      - platform: numeric_state
        entity_id: light.living_room_light
        value_template: '{{ state.attributes.brightness }}'
        below: '190'
    action:
      - service: light.turn_off
        entity_id: light.living_corner_lamp
      #- service: input_number.set_value
      #  data:
      #    entity_id: input_number.livingroom_dimmer
      #    value_template: '{{ state.light.living_room_light.attributes.brightness_pct }}'

  - alias: Living Room Light 75-100%
    trigger:
      - platform: numeric_state
        entity_id: light.living_room_light
        value_template: '{{ state.attributes.brightness }}'
        above: '190'
        # Delay to avoid premature turn on flash.
        for:
          seconds: 1
    action:
      #- service: input_number.set_value
      #  data:
      #    entity_id: input_number.livingroom_corner_dimmer
      #    value: 50
      - service: light.turn_on
        data:
          brightness_pct: '50'
          entity_id: light.living_corner_lamp

  ##############################################
  ## Living Room Slider Automations
  ##############################################
#  - alias: Living Room - Floor Lamp Turns ON
#    trigger:
#      - platform: state
#        entity_id: light.living_room_light
#        from: 'off'
#        to: 'on'
#    condition:
#      - below: '1'
#        condition: numeric_state
#        entity_id: input_number.livingroom_dimmer
#    action:
#      - service: input_number.set_value
#        data:
#          entity_id: input_number.livingroom_dimmer
#          value: '100'

#  - alias: Living Room - Corner Lamp Turns ON
#    trigger:
#      - platform: state
#        entity_id: light.living_corner_lamp
#        from: 'off'
#        to: 'on'
#    condition:
#      - condition: state
#        entity_id: input_number.livingroom_corner_dimmer
#        state: '0'
#    action:
#      - service: input_number.set_value
#        data:
#          entity_id: input_number.livingroom_corner_dimmer
#          value: '100'

#  - alias: Living Room - Corner Lamp Turns Off
#    trigger:
#      - platform: state
#        entity_id: light.living_corner_lamp
#        from: 'on'
#        to: 'off'
#    action:
#      - service: input_number.set_value
#        data:
#          entity_id: input_number.livingroom_corner_dimmer
#          value: '0'

#  - alias: Living Room - Corner Lamp Slider Changes
#    trigger:
#      - platform: state
#        entity_id: input_number.livingroom_corner_dimmer
#    action:
#      - service: light.turn_on
#        data:
#          entity_id: light.living_corner.lamp
#          brightness_pct: '{{ state.input_number.livingroom_corner_dimmer.attributes.state }}'
#        data_template:
#          entity_id: light.living_corner_lamp
#          brightness_pct: '{{ trigger.to_state.state | int }}'

#  - alias: Living Room - Floor Lamp Slider
#    trigger:
#      - platform: state
#        entity_id: input_number.livingroom_dimmer  
#    action:
#      - service: light.turn_on
#        data:
#          entity_id: light.living_room_light
#          brightness_pct: '{{ state.input_number.livingroom_dimmer.attributes.value }}'
#        data_template:
#          entity_id: light.living_room_light
#          brightness_pct: '{{ trigger.to_state.state | int }}'

  ##############################################
  ## Sunrise & Sunset Automations
  ##############################################
  ## 1 1/2 hours after sunrise.
  - alias: Morning +1.5hrs
    trigger:
      - platform: sun
        event: sunrise
        offset: '+1:30:00'
    action:
      - service: homeassistant.turn_off
        data:
          entity_id: group.morning_devices
      - service: script.notify_ios_engine
        data_template:
          value1: 'Scene: Morning Devices'
          value2: ''
          value3: "{{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p %d %b %Y', true) }}"
          who: "brian"
          #engines: persistent, ios
      - service: persistent_notification.create
        data:
          message: "Scene: Morning Devices activated at {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p %d %b %Y', true) }}"

  ## 45 minutes before sunset = "Dusk"
  - alias: Dusk
    trigger:
      - platform: sun
        event: sunset
        offset: -00:45:00
    condition:
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'
    action:
      - service: scene.turn_on
        entity_id: scene.dusk
      - service: script.notify_ios_engine
        data_template:
          value1: 'Scene: Dusk'
          value2: ''
          value3: "Activated at {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p %d %b %Y', true) }}"
          who: "brian"
      - service: persistent_notification.create
        data:
          message: "Scene: Dusk activated at {{ as_timestamp(now()) | timestamp_custom('%I:%M:%S %p %d %b %Y', true) }}"

  ## 1 hour after dusk.
  - alias: Dusk +1hr
    trigger:
      - platform: sun
        event: sunset
        offset: +0:15:00
    condition:
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'
    action:
      - service: script.turn_on
        entity_id: script.dusk_plus_1hr

  ## 1 1/2 hours after dusk.
  - alias: Dusk +1.5hrs
    trigger:
      - platform: sun
        event: sunset
        offset: +0:15:00
    condition:
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'
    action:
      - service: script.turn_on
        entity_id: script.dusk_plus_15hr

  ## 2 hours after dusk.
  - alias: Dusk +2hrs
    trigger:
      - platform: sun
        event: sunset
        offset: '+1:15:00'
    condition:
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'
    action:
      - service: script.turn_on
        entity_id: script.dusk_plus_2hrs

  ## 2 1/2 hours after dusk.
  - alias: Dusk +2.5hrs
    trigger:
      - platform: sun
        event: sunset
        offset: +0:15:00
    condition:
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'
    action:
      - service: script.turn_on
        entity_id: script.dusk_plus_25hr

  ## 3 hours after dusk.
  - alias: Dusk + 3hrs
    trigger:
      - platform: sun
        event: sunset
        offset: '+2:15:00'
    condition:
      - condition: state
        entity_id: input_boolean.dusk_dimmers_enabled
        state: 'on'
    action:
      - service: script.turn_on
        entity_id: script.dusk_plus_3hrs


  ##############################################
  ## Experimental Automations
  ##############################################
  - alias: Turn Living Room Light On With Movement
    trigger:
      - platform: state
        entity_id: binary_sensor.living_room_motion
        to: 'on'
    condition:
      - condition: state
        entity_id: input_boolean.experiments_enabled
        state: 'on'
    action:
      - service: homeassistant.turn_on
        entity_id: light.living_corner_lamp

  - alias: Turn Living Room Light Off After Movement Ends
    trigger:
      platform: state
      entity_id: binary_sensor.living_room_motion
      to: 'off'
      for:
        seconds: 10
    condition:
      - condition: state
        entity_id: input_boolean.experiments_enabled
        state: 'on'
    action:
      - service: homeassistant.turn_off
        entity_id: light.living_corner_lamp