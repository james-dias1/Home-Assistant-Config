# homeassistant:
#   customize:
#     group.all_lights:
#       hidden: false
    # light.dining_room_light:
    #   friendly_name: "Dining Room"

################################################
## Component Settings
################################################
## Hue Light Hub
#######################
# hue:
#   bridges:
#     - host: 10.0.0.37
#       allow_unreachable: true
#       allow_hue_groups: false

## Insteon Dimmer Plugs
#######################
insteon:
  host: 10.0.0.30
  username: !secret insteon_user
  password: !secret insteon_pass
  timeout: 300

## Wink Z-Wave Devices
#######################
wink:
  #local_control: true


################################################
## Switches
################################################
input_boolean:
  bedroom_light_sync_enabled:
    name: Bedroom Light Sync
    icon: mdi:lightbulb-outline
    initial: on
  
  shoe_closet_timeout:
    name: Shoe Closet Light Timeout
    icon: mdi:lightbulb-outline
    initial: on

################################################
## Sensors
################################################
sensor:
  - platform: template
    sensors:
      lights_on:
        value_template: >
          {% macro get_lights_on() -%}
            {%- for group in states.light|groupby('state') -%}
              {%- for entity in group.list -%}
                {%- if entity.state == 'on'
                    and entity.entity_id|lower != 'light.3a4e12'
                    and entity.entity_id|lower != 'light.3a4f5b'
                    and entity.entity_id|lower != 'light.3a542c'
                    and entity.entity_id|lower != 'light.3a5e44'
                    and entity.entity_id|lower != 'light.3a76dc'
                    and entity.entity_id|lower != 'light.3a7703'
                    and entity.entity_id|lower != 'light.entry'
                    and entity.entity_id|lower != 'light.hue'
                    and entity.entity_id|lower != 'switch.boys_bathroom_nightlight'
                    and not ('garage_entry'  in entity.entity_id|lower)
                    and not ('shoe_closet'   in entity.entity_id|lower)
                    and not ('gateway_light' in entity.entity_id|lower)
                    and not (entity.entity_id|lower).endswith('nightlight') -%}
                  {{ entity.entity_id }}{{ ' ' }}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
            {%- for group in states.switch|groupby('state') -%}
              {%- for entity in group.list -%}
                {%- if  entity.state == 'on'
                    and ('_light' in entity.entity_id|lower) -%}
                  {{ entity.entity_id }}{{ ' ' }}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- endmacro %}
          {{ get_lights_on()|trim|replace(' ', ',') }}

################################################
## Lights
################################################
light:
  - platform: group
    name: Bedroom Lights
    entities:
      - light.nerenes_light
      - light.brians_lamp

  - platform: group
    name: Family Room Lights
    entities:
      - light.family_room_light
      - light.family_room_table_lamp

  - platform: group
    name: Kitchen Lights
    entities:
      - light.kitchen_light
      - light.kitchen_prep_light

  - platform: group
    name: Outdoor Lighting
    entities:
      - light.porch_light
      - light.landscape_lights

  - platform: insteon

################################################
## Switches
################################################
switch:
  platform: insteon

################################################
## Automations
################################################
automation:
  - alias: sensor.lights_on force update
    trigger:
      platform: event
      event_type: state_changed
    condition:
      # Only when the change was to the lights.
      - condition: template
        value_template: "{{ trigger.event.data is not none 
                        and trigger.event.data.entity_id is not none
                        and 'light' in trigger.event.data.entity_id|lower }}"
    action:
      service: homeassistant.update_entity
      entity_id: sensor.lights_on

  - alias: "Shoe Closet: Open"
    trigger:
      platform: state
      entity_id: binary_sensor.shoe_closet_door
      to: "on"
    action:
      service: light.turn_on
      entity_id: light.shoe_closet_light

  - alias: "Shoe Closet: Closed"
    trigger:
      platform: state
      entity_id: binary_sensor.shoe_closet_door
      to: "off"
    action:
      service: light.turn_off
      entity_id: light.shoe_closet_light

  - alias: Shoe Closet Timeout
    trigger:
      platform: state
      entity_id: binary_sensor.shoe_closet_door
      from: "off"
      to: "on"
      for:
        minutes: 5
    action:
      - condition: state
        entity_id: input_boolean.shoe_closet_timeout
        state: 'on'
      - service: light.turn_off
        entity_id: light.shoe_closet_light