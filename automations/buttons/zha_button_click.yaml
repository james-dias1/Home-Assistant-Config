---
alias: zha_button_click
initial_state: true
#mode: parallel
mode: restart # Force restart to pickup double click
trigger:
  platform: event
  event_type: zha_event
condition:
  # Ignore Xiaomi button release events.
  - condition: template
    value_template: '{{ trigger.event.data.args.value != false }}'
action:
  - choose:
      # Printer Power Button
      - conditions:
          - condition: template
            value_template: '{{ trigger.event.data.device_ieee == "00:15:8d:00:01:2d:d7:c3" }}'
        sequence:
          - service: switch.toggle
            entity_id: switch.printers

      # Xiaomi Mini Switch
      - conditions:
          - condition: template
            value_template: '{{ trigger.event.data.device_ieee == "00:15:8d:00:02:05:bf:0f" }}'
        sequence:
          - service: persistent_notification.create
            data_template:
              title: "test_switch_button"
              message: "Button pressed"

      # Bedroom Double Switch
      - conditions:
          - condition: template
            value_template: '{{ trigger.event.data.device_ieee == "00:15:8d:00:02:83:e2:b6" }}'
        sequence:
          choose:
            # Single Click: Left
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "left_single" }}'
              sequence:
                - service: light.toggle
                  entity_id: light.bedroom
            # Single Click: Right
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "right_single" }}'
              sequence:
                - service: light.toggle
                  entity_id: light.brian
            # Single Click: Both
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "both_single" }}'
              sequence:
                - service: light.toggle
                  entity_id: light.glowforge
            # Double Click: Left
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "left_double" }}'
              sequence:
                - service: switch.toggle
                  entity_id: switch.sound_machine
            # Double Click: Right
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "right_double" }}'
              sequence:
                - service: switch.toggle
                  entity_id: switch.bedroom_fan
            # Double Click: Both
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "both_double" }}'
              sequence:
                - service: switch.toggle
                  entity_id:
                    - switch.sound_machine
                    - switch.bedroom_fan

      # Brian's Ikea 5 button remote
      - conditions:
          - condition: template
            value_template: '{{ trigger.event.data.device_ieee == "ec:1b:bd:ff:fe:23:9c:ee" }}'
        sequence:
          choose:
            # Button: Power (middle)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "toggle" }}'
              sequence:
                # Store the previous click values.
                - service: input_text.set_value
                  data_template:
                    entity_id: input_text.zha_click
                    # CSV Order: click_delta, click, command
                    # {% set click_delta = states("input_text.zha_click").split(",")[0] %}
                    # {% set click       = states("input_text.zha_click").split(",")[1] %}
                    # {% set command     = states("input_text.zha_click").split(",")[2] %}
                    value: >-
                      {%- set click = as_timestamp(now())|float %}
                      {%- set previous_click =  states("input_text.zha_click").split(",")[1]|float %}
                      {{- click - previous_click }},
                      {{- click }},
                      {{- trigger.event.data.command }}

                - choose:
                    # Double click
                    #   * second click must occur within 1/2 second of the first click. 
                    - conditions:
                        - condition: template
                          value_template: |
                            {% set click_delta = states("input_text.zha_click").split(",")[0]|float %}
                            {% set previous_command = states("input_text.zha_click").split(",")[2]|trim %}
                            {{ click_delta <= 0.5 and previous_command == "toggle" }}
                      sequence:
                        - service: switch.toggle
                          entity_id: switch.tv_family_room

                  # Single Click
                  default:
                    # Delay 1/2 second to allow for a second click to cancel the first action.
                    - delay:
                        seconds: 0.5
                    
                    # Toggle the fan.
                    - service: switch.toggle
                      entity_id: switch.family_room_fan
                
                
            # Single Click: Brightness Up (top)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "step_with_on_off" }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id:
                      - light.family_room
                      - light.table_lamp
                    brightness_pct: 100
            # Single Click: Brightness down (bottom)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "step" }}'
              sequence:
                - service: light.turn_off
                  entity_id:
                    - light.family_room
                    - light.table_lamp
            # Single Click: Arrow left (left)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "press"
                                  and trigger.event.data.args[0]|int == 256 }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.family_room_floor_lamp
                    brightness_pct: 100
            # Single Click: Arrow right (right)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "press"
                                    and trigger.event.data.args[0]|int == 257 }}'
              sequence:
                - service: light.turn_off
                  entity_id: light.family_room_floor_lamp

            # Hold: Brightness Up (top)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "move" }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id:
                      - light.family_room
                      - light.table_lamp
                    brightness_step_pct: "-20"
            # Hold: Brightness down (bottom)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "move_with_on_off" }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id:
                      - light.family_room
                      - light.table_lamp
                    brightness_step_pct: "20"
            # Hold: Arrow left (left)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "hold"
                                  and trigger.event.data.args[0]|int == 3329 }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.family_room_floor_lamp
                    brightness_step_pct: "-20"
            # Hold: Arrow right (right)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "hold"
                                    and trigger.event.data.args[0]|int == 3328 }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.family_room_floor_lamp
                    brightness_step_pct: "20"
