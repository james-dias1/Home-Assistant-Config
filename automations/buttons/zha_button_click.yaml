---
alias: ZHA Button Clicks
id: zha_button_click
initial_state: true
#mode: parallel
mode: restart # Force restart to pickup double click
max_exceeded: silent
trigger:
  platform: event
  event_type: zha_event
  # event_data:
  #   data.device_ieee == "ec:1b:bd:ff:fe:23:9c:ee"
condition:
  # Ignore Xiaomi button release events.
  - '{{ trigger.event.data.args.value != false }}'
action:
  - choose:
      # Printer Power Button
      #   * Xiaomi Mijia Wireless Switch (round)
      - conditions: '{{ trigger.event.data.device_ieee == "00:15:8d:00:01:2d:d7:c3" }}'
        sequence:
          # Ignore Xiaomi button duplicate event.
          - condition: template
            value_template: '{{ trigger.event.data.args.value|int == 1 }}'

          # - service: script.debug
          #   data_template:
          #     message: Xiaomi Mijia Wireless Switch (round) Clicked
          #     id: '{{ as_timestamp(now()) }}'

          - service: switch.toggle
            entity_id: switch.printers

      # Unused
      #   * Xiaomi Aqara Wireless Mini Switch (square)
      - conditions: '{{ trigger.event.data.device_ieee == "00:15:8d:00:02:05:bf:0f" }}'
        sequence:
          # - service: script.toast
          #   data_template:
          #     message: Xiaomi Aqara Wireless Mini Switch Clicked

          - service: script.debug
            data_template:
              message: Xiaomi Aqara Wireless Mini Switch Clicked
              id: '{{ as_timestamp(now()) }}'

      # Bedroom Double Switch
      #   * Xiaomi Double Rockers, Battery Powered
      - conditions: '{{ trigger.event.data.device_ieee == "00:15:8d:00:02:83:e2:b6" }}'
        sequence:
          # Ignore Xiaomi button duplicate event.
          # - condition: template
          #   value_template: '{{ trigger.event.data.args.value|int == 1 }}'

          - choose:
              # Single Click: Left
              - conditions: '{{ trigger.event.data.command == "left_single" }}'
                sequence:
                  - service: light.toggle
                    entity_id: light.bedroom
              # Single Click: Right
              - conditions: '{{ trigger.event.data.command == "right_single" }}'
                sequence:
                  - service: light.toggle
                    entity_id: light.brian
              # Single Click: Both
              - conditions: '{{ trigger.event.data.command == "both_single" }}'
                sequence:
                  - service: light.toggle
                    entity_id: light.glowforge
              # Double Click: Left
              - conditions: '{{ trigger.event.data.command == "left_double" }}'
                sequence:
                  - service: switch.toggle
                    entity_id: switch.sound_machine
              # Double Click: Right
              - conditions: '{{ trigger.event.data.command == "right_double" }}'
                sequence:
                  - service: switch.toggle
                    entity_id: switch.bedroom_fan
              # Double Click: Both
              - conditions: '{{ trigger.event.data.command == "both_double" }}'
                sequence:
                  - service: switch.toggle
                    entity_id:
                      - switch.sound_machine
                      - switch.bedroom_fan

      # Family Room 5 button remote
      #   * IKEA Tradfri Remote Control
      - conditions: '{{ trigger.event.data.device_ieee == "ec:1b:bd:ff:fe:23:9c:ee" }}'
        sequence:
          choose:
            # Button: Power (middle)
            - conditions:
                - condition: template
                  value_template: '{{ trigger.event.data.command == "toggle" }}'
              sequence:
                # Store the previous click values and decide if this click was a double click or not.
                - service: script.zha_store_click
                  data_template:
                    device: '{{ trigger.event.data.device_ieee }}'
                    command: '{{ trigger.event.data.command }}'

                - choose:
                    # 2 clicks
                    - conditions: '{{ 2 == states("input_text.zha_click").split(",")[3]|int }}'
                      sequence:
                        # Delay 0.5 second to allow for a second click to cancel the second action.
                        - delay:
                            seconds: 0.5
                        
                        - service: switch.toggle
                          entity_id: switch.tv_family_room

                    # 3 clicks
                    - conditions: '{{ 3 == states("input_text.zha_click").split(",")[3]|int }}'
                      sequence:
                        # Delay 0.5 second to allow for a second click to cancel the third action.
                        - delay:
                            seconds: 0.5
                        
                        - choose:
                            # The door us locked
                            - conditions: '{{ states("lock.front_door")|lower|trim == "locked" }}'
                              sequence:
                                - service: lock.unlock
                                  entity_id: lock.front_door
                                
                                - service: input_boolean.turn_on
                                  entity_id: input_boolean.leave_unlocked

                          # The door is unlocked
                          default:
                            - service: input_boolean.turn_off
                              entity_id: input_boolean.leave_unlocked
                            
                            - service: lock.lock
                              entity_id: lock.front_door

                    # 4 clicks
                    - conditions: '{{ 4 == states("input_text.zha_click").split(",")[3]|int}}'
                      sequence:
                        # Delay 0.5 second to allow for a second click to cancel the third action.
                        #- delay:
                        #    seconds: 0.5
                        
                        - service: input_boolean.toggle
                          entity_id: input_boolean.guest_mode

                  # Single Click
                  default:
                    # Delay 0.5 second to allow for a second click to cancel the first action.
                    - delay:
                        seconds: 0.5

                    # Toggle the fan.
                    - service: fan.toggle
                      entity_id: fan.family_room
                      
            # Single Click: Brightness Up (top)
            - conditions: '{{ trigger.event.data.command == "step_with_on_off" }}'
              sequence:
                # Store the previous click values and decide if this click was a double click or not.
                - service: script.zha_store_click
                  data_template:
                    device: '{{ trigger.event.data.device_ieee }}'
                    command: '{{ trigger.event.data.command }}'

                - choose:
                    # Double click
                    - conditions: '{{ 2 == states("input_text.zha_click").split(",")[3]|int }}'
                      sequence:
                        # Delay 0.5 second to allow for a second click to cancel the second action.
                        - delay:
                            seconds: 0.5

                        - service: light.turn_on
                          data:
                            entity_id: light.table_lamp
                            brightness_pct: 100

                  # Single Click
                  default:
                    # Delay 0.5 second to allow for a second click to cancel the first action.
                    - delay:
                        seconds: 0.5
                    - service: light.turn_on
                      data:
                        entity_id: light.family_room
                        brightness_pct: 100

            # Single Click: Brightness down (bottom)
            - conditions: '{{ trigger.event.data.command == "step" }}'
              sequence:
                # Store the previous click values and decide if this click was a double click or not.
                - service: script.zha_store_click
                  data_template:
                    device: '{{ trigger.event.data.device_ieee }}'
                    command: '{{ trigger.event.data.command }}'

                - choose:
                    # Double click
                    - conditions: '{{ 2 == states("input_text.zha_click").split(",")[3]|int }}'
                      sequence:
                        # Delay 0.5 second to allow for a second click to cancel the second action.
                        - delay:
                            seconds: 0.5

                        - service: light.turn_off
                          entity_id: light.table_lamp

                  # Single Click
                  default:
                    # Delay 0.5 second to allow for a second click to cancel the first action.
                    - delay:
                        seconds: 0.5
                    - service: light.turn_off
                      entity_id:
                        - light.family_room
                        - light.table_lamp

            # Single Click: Arrow left (left)
            - conditions: '{{ trigger.event.data.command == "press"
                          and trigger.event.data.args[0]|int == 256 }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.family_room_floor_lamp
                    brightness_pct: 100
            # Single Click: Arrow right (right)
            - conditions: '{{ trigger.event.data.command == "press"
                          and trigger.event.data.args[0]|int == 257 }}'
              sequence:
                - service: light.turn_off
                  entity_id: light.family_room_floor_lamp

            # Hold: Brightness Up (top)
            - conditions: '{{ trigger.event.data.command == "move" }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id:
                      - light.family_room
                      - light.table_lamp
                    brightness_step_pct: "-20"
            # Hold: Brightness down (bottom)
            - conditions: '{{ trigger.event.data.command == "move_with_on_off" }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id:
                      - light.family_room
                      - light.table_lamp
                    brightness_step_pct: "20"
            # Hold: Arrow left (left)
            - conditions: '{{ trigger.event.data.command == "hold"
                          and trigger.event.data.args[0]|int == 3329 }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.family_room_floor_lamp
                    brightness_step_pct: "-20"
            # Hold: Arrow right (right)
            - conditions: '{{ trigger.event.data.command == "hold"
                          and trigger.event.data.args[0]|int == 3328 }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.family_room_floor_lamp
                    brightness_step_pct: "20"
