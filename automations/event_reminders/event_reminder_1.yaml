---
alias: event_reminder_1
trigger:
  platform: template
  value_template: >-
    {% set current_time = states('sensor.time')|timestamp_custom('%H:%M', false) %}
    {{ is_state('sensor.event_reminder_1_1',current_time)
    or is_state('sensor.event_reminder_1_2',current_time) }}
condition:
  condition: and
  conditions:
    # Is today one of the selected days?
    - condition: template
      value_template: >
        {% set   day_name = now().strftime("%A")|lower -%}
        {%- if   day_name == 'monday'    and states.input_boolean.event_reminder_1_mon.state == 'on' -%}{{true}}
        {%- elif day_name == 'tuesday'   and states.input_boolean.event_reminder_1_tue.state == 'on' -%}{{true}}
        {%- elif day_name == 'wednesday' and states.input_boolean.event_reminder_1_wed.state == 'on' -%}{{true}}
        {%- elif day_name == 'thursday'  and states.input_boolean.event_reminder_1_thu.state == 'on' -%}{{true}}
        {%- elif day_name == 'friday'    and states.input_boolean.event_reminder_1_fri.state == 'on' -%}{{true}}
        {%- elif day_name == 'saturday'  and states.input_boolean.event_reminder_1_sat.state == 'on' -%}{{true}}
        {%- elif day_name == 'sunday'    and states.input_boolean.event_reminder_1_sun.state == 'on' -%}{{true}}
        {%- else -%}{{false}}{%- endif %}
action:
  # - service: persistent_notification.create
  #   data_template:
  #     title: "DEBUG"
  #     message: "automation.event_reminder_1"

  - service_template: >
      {% if is_state('input_boolean.event_reminder_1_skipnext', 'on') %}
        script.event_reminder_skipnext
      {% else %}
        script.event_reminder_announce
      {% endif %}
    data_template:
      id: "1"
      message: >-
        {% set current_time = states('sensor.time')|timestamp_custom('%H:%M', false) %}
        {% if is_state('sensor.event_reminder_1_1',current_time) %}
          {{ states('input_text.event_reminder_1_1') }}
        {% else %}
          {{ states('input_text.event_reminder_1_1') }}
        {% endif %}

  # Run this routine for the second reminder, but not the first.
  - condition: template
    value_template: >-
      {% set current_time = states('sensor.time')|timestamp_custom('%H:%M', false) %}
      {{ is_state('sensor.event_reminder_1_2',current_time) }}
  - service: script.goodbye_routine
