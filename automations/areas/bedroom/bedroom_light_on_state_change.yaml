---
##############################################
## Bed Room Light Automations
##############################################
alias: Bedroom Light on State Change
id: bedroom_light_on_state_change
initial_state: true
mode: single
trigger:
  - platform: state
    entity_id: light.bedroom
variables:
  old_state: '{{ trigger.event.data.old_state.state|lower }}'
  new_state: '{{ trigger.event.data.new_state.state|lower }}'

  light_sync_enabled: '{{ states("input_boolean.bedroom_light_sync") }}'
  nerene_battery_charging: '{{ is_state_attr("device_tracker.life360_nerene","battery_charging",True) }}'
  wakeup_hour: states("input_datetime.wakeup_nerene_time").split(":")[0]|int
  hour: states("sensor.time").split(":")[0]|int

condition:
  - '{{ new_state == "Off" }}'
  # Skip if the:
  #   * current state is "unavailable"
  #   * state is the same as before
  - '{{
        (new_state in ["off","on"] and old_state in ["off","on"])
        and old_state != new_state
      }}'
action:
  # - service: script.debug
  #   data:
  #     message: |
  #       old_state: {{ old_state }}
  #       new_state: {{ new_state }}

  - choose:
      - conditions: '{{ light_sync_enabled == "on" }}'
        sequence:
          - service: 'light.turn_{{ "on" if new_state == "on" else "off" }}'
            entity_id:
              - light.brian
              - light.glowforge

  - choose:
      # Try to only turn the fan and sound machine off if Nerene is on her way out the door for work.
      - conditions:
          - '{{ new_state == "off" }}'
          - '{{ nerene_battery_charging == False }}'
          - '{{ wakeup_hour == hour }}'
        sequence:
          - service: homeassistant.turn_off
            entity_id:
              - fan.bedroom
              - switch.sound_machine
