---
alias: front_door_unlocked
initial_state: true
trigger:
  - platform: state
    entity_id: lock.front_door
    from: 'locked'
    to: 'unlocked'

  # - platform: state
  #   entity_id: lock.test_door
  #   from: 'locked'
  #   to: 'unlocked'
variables:
  lock: '{{ trigger.entity_id }}'
  state: '{{ trigger.to_state.state }}'

action:
  # - service: script.debug
  #   data:
  #     message: |
  #       entity_id: '{{ lock }}'
  #       state: '{{ state }}'

  # Start a countdown timer to relock the front door.
  - choose:
      - conditions: '{{ state == "unlocked"
                      and "off" == states("input_boolean.guest_mode")
                      and "off" == states("input_boolean.leave_unlocked") }}'
        sequence:
          # Start a countdown timer to relock the front door.
          - service: timer.start
            data_template:
              entity_id: timer.front_door_unlocked

  ## ================================================================================================= ##

  # Skip turning on the entry lights in the middle of the day.
  - choose:
      - conditions: "{{ states('sensor.outdoor_illuminance')|int < 2000 }}"
        sequence:
          # Store the current state of the porch + entry lights.
          - service: scene.create
            data:
              scene_id: front_door_locked_lights_snapshot
              snapshot_entities:
                - light.home_entry
                - light.porch

          # Disable Adaptive Lighting automated control.
          - service: adaptive_lighting.set_manual_control
            data:
              entity_id:
                - switch.adaptive_lighting_home_entry
                - switch.adaptive_lighting_porch
              manual_control: true

          # Full brightness!
          - service: light.turn_on
            data:
              brightness: 255
              entity_id:
                - light.home_entry
                - light.porch

  ## ================================================================================================= ##

  # Update Light Switch LED Status Color.
  - service: script.inovelli_led_status_start
    data:
      entity_id: light.family_room
      color: pink
      state_entity: lock.front_door
      state: "unlocked"
