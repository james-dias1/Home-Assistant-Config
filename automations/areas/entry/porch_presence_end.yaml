---
##############################################
###  Porch
##############################################
# Porch Presence: Timeout
alias: Porch Presence End
id: porch_presence_end
initial_state: true
mode: single
trigger:
  - platform: state
    entity_id:
      - binary_sensor.front_door_motion
      #- binary_sensor.doorbell_motion
    from: 'on'
    to: 'off'
    # for:
    #   minutes: 10
action:
  - choose:
      - conditions:
          # Only activate the lights after sunset.
          - condition: sun
            after: sunset
        sequence:
          # Restore Adaptive Lighting automated control.
          - service: adaptive_lighting.set_manual_control
            data:
              entity_id: switch.adaptive_lighting_porch
              manual_control: false

          - delay:
              seconds: 1

          # Restore the previous state of the porch light.
          - service: scene.turn_on
            data:
              entity_id: scene.doorbell_presence_lights_snapshot
              transition: 5

          # Cool down timer. When "mode: single" this stops this automation from running more often than this.
          - delay:
              minutes: 5
