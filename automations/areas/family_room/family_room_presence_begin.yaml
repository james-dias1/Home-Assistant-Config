---
# Family Room Light Presence Trigger
alias: "Family Room Presence Begin"
id: family_room_presence_begin
initial_state: true
mode: single
trigger:
  # Trigger if either motion sensor is on.
  - platform: state
    entity_id:
      - binary_sensor.family_room_1_presence_live
      - binary_sensor.family_room_2_presence_live
    to: "on"
condition:
  # Skip when the light is already on.
  - condition: state
    entity_id: light.family_room
    state: "off"

  # Skip turning on the lights in the middle of the day.
  - condition: state
    entity_id: binary_sensor.dark_outside
    state: "on"

  # We don't need to turn on the light when the dogs are alone.
  # - condition: state
  #   entity_id: input_boolean.away_mode
  #   state: "off"
action:
  # - service: persistent_notification.create
  #   data_template:
  #     title: "family_room_presence_start"
  #     message: "Triggered by: {{ trigger.to_state.attributes.friendly_name }}\nto_state: {{ trigger.to_state.state }}\nfrom_state: {{ trigger.from_state.state }}"


  # Restore the presence lights after 4 hours have passed since it was manually disabled.
  - choose:
      - conditions:
          # If it is disabled proceed to the next checkpoint.
          - condition: template
            value_template: "{{ is_state('input_boolean.presence_lights_family_room','off')  }}"
        sequence:
          - choose:
            - conditions:
              # If it has been disabled for more than 4 hours, reenable presence lights.
              - condition: template
                value_template: >
                  {% set last_changed = states.input_boolean.presence_lights_family_room.last_changed %}
                  {% set hours_since = (as_timestamp(now()) - as_timestamp(last_changed)) / 60 / 60 %}
                  {{ hours_since > 4 }}
              sequence:
                - service: input_boolean.turn_on
                  entity_id: input_boolean.presence_lights_family_room

  # Stop if the presence lights mode is disabled.
  - condition: state
    entity_id: input_boolean.presence_lights_family_room
    state: "on"

  # Family Room Presence Light(s) On
  - service: scene.turn_on
    entity_id: scene.family_room_normal

  # Cool down timer. When "mode: single" this stops this automation from running more often than this.
  - delay:
      minutes: 10
