---
##############################################################################
###  Family Member Departure
##############################################################################
alias: family_departure
initial_state: true
trigger:
  - platform: state
    entity_id:
      - person.brian
      - person.eric
      - person.heather
      # - person.kyle
      - person.lucas
      - person.nerene
      - person.sandy

      # Frequent visitors
      # - person.cindy
      # - person.melissa
    from: 'home'
    to: 'not_home'
    for:
      minutes: 5
      seconds: 0
action:
  - service: variable.set_variable
    data:
      variable: left_home
      attributes_template: >
        {%- macro person_left(name) %}
          {%- if name == trigger.to_state.attributes.friendly_name %}
            {{- now() }}
          {%- else %}
            {{- state_attr('variable.left_home','name') }}
          {%- endif %}
        {%- endmacro %}
        {
          "Brian": "{{ person_left("Brian") }}",
          "Eric": "{{ person_left("Eric") }}",
          "Heather": "{{ person_left("Heather") }}",
          "Lucas": "{{ person_left("Lucas") }}",
          "Nerene": "{{ person_left("Nerene") }}",
          "Sandy": "{{ person_left("Sandy") }}",
          "last_updated": "{{ as_timestamp(now()) | timestamp_custom('%b %d %I:%M %p', true) }}"
        }
    data_template:
      value: "{{ trigger.to_state.attributes.friendly_name }}"
