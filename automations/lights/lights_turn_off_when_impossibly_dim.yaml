---
alias: lights_turn_off_when_impossibly_dim
initial_state: true
trigger:
  # - platform: event
  #   event_type: state_changed
  #   event_data:
  #     domain: light
  - platform: time_pattern
    minutes: '/10'
action:
  # - service: script.debug
  #   data_template:
  #     message: >
  #       {#- Lights with a brightness < 30%. #}
  #       {%- set group_id = 'group.actionable_lights' -%}
  #       {%- set dim_lights = states.light | selectattr('attributes.brightness','defined') | selectattr('attributes.brightness','lt',75) | selectattr('entity_id','in',state_attr(group_id,'entity_id')) | map(attribute='entity_id') | join(', ')-%}
  #       {{ dim_lights }}

  - condition: template
    value_template: >
        {%- set group_id = 'group.actionable_lights' -%}
        {%- set exclude_list = [
              'light.porch'
        ] %}
        {%- set dim_lights = states.light | rejectattr('entity_id','in',exclude_list) | selectattr('attributes.brightness','defined') | selectattr('attributes.brightness','lt',75) | selectattr('entity_id','in',state_attr(group_id,'entity_id')) | map(attribute='entity_id') | join(', ')-%}
        {{ dim_lights|length > 0 }}

  # Turn off lights with a brightness under 30%.
  - service: light.turn_on
    data_template:
      brightness: 0
      entity_id: >
        {%- set group_id = 'group.actionable_lights' -%}
        {%- set exclude_list = [
              'light.porch'
        ] %}
        {%- set dim_lights = states.light | rejectattr('entity_id','in',exclude_list) | selectattr('attributes.brightness','defined') | selectattr('attributes.brightness','lt',75) | selectattr('entity_id','in',state_attr(group_id,'entity_id')) | map(attribute='entity_id') | join(', ')-%}
        {{ dim_lights }}
