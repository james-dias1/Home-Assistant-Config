---
alias: Away Mode
id: away_mode_on_state_change

trigger:
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: input_boolean.away_mode
variables:
  old_state: '{{ trigger.event.data.old_state.state }}'
  new_state: '{{ trigger.event.data.new_state.state }}'
condition:
  - '{{ (new_state in ["off","on"] and old_state in ["off","on"])
      and old_state != new_state }}'
action:
  - choose:
      - conditions: '{{ new_state == "on" }}'
        sequence:
          # Close the garage door (if it was inadvertently left open).
          - choose:
              - conditions: '{{ states("cover.garage_door") != "closed" }}'
                sequence:
                  - service: cover.close_cover
                    entity_id: cover.garage_door
          - choose:
              - conditions: '{{ states("lock.front_door") != "locked" }}'
                sequence:
                  - service: lock.lock
                    entity_id: lock.front_door

          - choose:
              - conditions: '{{ states("climate.bedroom") != "off" }}'
                sequence:
                  - service: climate.turn_off
                    entity_id: climate.bedroom
          - choose:
              - conditions: '{{ states("climate.lucas_room") != "off" }}'
                sequence:
                  - service: climate.turn_off
                    entity_id: climate.lucas_room

          # Run the shutdown/goodbye routine (without the verbal confirmation).
          - service: script.turn_on
            entity_id: script.shutdown_routine
