---
# When a timer finishes.
alias: xpresence_timer_expired
initial_state: true
mode: queued
trigger:
  - platform: state
    from: active
    to: idle
    entity_id:
      - timer.xpresence_brian
      - timer.xpresence_eric
      - timer.xpresence_heather
      - timer.xpresence_lucas
      - timer.xpresence_nerene
      - timer.xpresence_sandy

variables:
  old_state: '{{ trigger.from_state.state|lower }}'
  new_state: '{{ trigger.to_state.state|lower }}'

  person: '{{ trigger.entity_id.split("_")[1] }}'
  current_option: '{{ states("input_select." + person) }}'
  next_options:
    "Just Arrived": "Home"
    "Just Left": "Away"
    "Away": "Extended Away"
  next_option: '{{ next_option[current_option] }}'

action:
  # Change the status to Just Left or Just Arrived.
  - service: input_select.select_option
    data_template:
      entity_id: 'input_select.{{ person }}'
      option: '{{ next_option }}'

  # Is the current state "Away"?
  - condition: template
    value_template: '{{ current_state == "Away" }}'

  # "Away" doesn't become "Extended Away" for 24 hours.
  - service: timer.start
    data_template:
      entity_id: 'timer.xpresence_{{ person }}'
      duration: '23:59:59'
