---
alias: xpresence_location_update
initial_state: true
mode: queued
trigger:
  - platform: state
    entity_id:
      - person.brian
      - person.eric
      - person.heather
      - person.lucas
      - person.nerene
      - person.sandy
    from: "not_home"
    to: "home"
  - platform: state
    entity_id:
      - person.brian
      - person.eric
      - person.heather
      - person.lucas
      - person.nerene
      - person.sandy
    from: "home"
    to: "not_home"

variables:
  hour: '{{ states("sensor.time").split(":")[0]|int }}'
  new_state: '{{ trigger.to_state.state }}'
  option: |
    {%- if new_state == "home" -%}
      Just Arrived
    {%- elif new_state == "not_home" -%}
      Just Left
    {%- endif -%}
  person: '{{ trigger.to_state.object_id }}'
  source: '{{ trigger.to_state.attributes.source }}'
  uptime_minutes: '{{ (as_timestamp(now()) - as_timestamp(states("sensor.last_restart")))|float / 60 }}'

condition:
  # Don't allow status change immediately at startup to avoid phantom changes.
  - condition: template
    value_template: '{{ uptime_minutes > 1 }}'

  # Ignore UniFi sourced changes overnight to help avoid false aways caused by sleepy iPhones.
  - condition: template
    value_template: '{{ hour < 6 and source.endswith("_unifi")  }}' # from 0-6am (24h format)

action:
  # - service: script.debug
  #   data_template:
  #     title: "automation.xpresence_location_update"
  #     message: |
  #       input_select.{{ person }}
  #       timer.xpresence_{{ person }}

  # Change the status to Just Left or Just Arrived.
  - service: input_select.select_option
    data:
      entity_id: "input_select.{{ person }}"
      option: "{{ option }}"

  # Start "Just" status countdown.
  - service: timer.start
    data:
      entity_id: "timer.xpresence_{{ person }}"
      duration: "00:10:00"
