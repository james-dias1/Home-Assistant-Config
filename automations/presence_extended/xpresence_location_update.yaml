---
alias: xpresence_location_update
initial_state: true
mode: queued
trigger:
  - platform: state
    entity_id:
      - person.brian
      - person.eric
      - person.heather
      - person.lucas
      - person.nerene
      - person.sandy
    from: "not_home"
    to: "home"
  - platform: state
    entity_id:
      - person.brian
      - person.eric
      - person.heather
      - person.lucas
      - person.nerene
      - person.sandy
    from: "home"
    to: "not_home"

condition:
  # Don't allow status change immediately at startup to avoid phantom changes.
  - condition: template
    value_template: |
      {% set uptime_minutes = (as_timestamp(now()) - as_timestamp(states("sensor.last_restart")))|float / 60 %}
      {{ uptime_minutes > 1 }}

action:
  - service: script.debug
    data_template:
      title: "automation.xpresence_location_update"
      message: >
        input_select.{{ trigger.entity_id.split('.')[1] }}
        timer.xpresence_{{ trigger.to_state.object_id }}

  # Change the status to Just Left or Just Arrived.
  - service: input_select.select_option
    data:
      entity_id: "input_select.{{ trigger.entity_id.split('.')[1] }}"
      option: >
        {%- if trigger.from_state.state == "home" -%}
          Just Left
        {%- else -%}
          Just Arrived
        {%- endif -%}

  # Start "Just" status countdown.
  - service: timer.start
    data:
      entity_id: "timer.xpresence_{{ trigger.to_state.object_id }}"
      duration: "00:10:00"
