---
# Sends alerts when a new release is available.
#
alias: Home Assistant Update Notification
id: homeassistant_update_notification
initial_state: true
trigger:
  - platform: numeric_state
    entity_id: sensor.home_assistant_updates
    above: 0
action:
  - service: script.toast
    data_template:
      message: |
        {%- if states("sensor.home_assistant_updates") == 1 %} 
          There is an update available.
        {%- else %}
          There are {{states("sensor.home_assistant_updates") }} updates available.
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","core","True") %}
          * There is a Core update.
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","supervisor","True") %}
          * There is a Supervisor update.
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","hacs","True") %}
          {%- set updates = states("sensor.hacs")|int|default("0") %}
          {%- if updates == 1 %}
            * There is one HACS update.
          {%- else %}
            * There are {{ updates }} HACS updates.
          {%- endif %}
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","addons","True") %}
          {%- set updates = states("sensor.addon_updates")|int|default("0") %}
          {%- if updates == 1 %}
            * There is one Addon update.
          {%- else %}
            * There are {{ updates }} Addon updates.
          {%- endif %}
        {%- endif %}
      duration: 10000

  - service: script.notify_mobile
    data_template:
      title: "Home Assistant Update"
      message: |
        {%- if states("sensor.home_assistant_updates") == 1 %} 
          There is an update available.
        {%- else %}
          There are {{states("sensor.home_assistant_updates") }} updates available.
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","core","True") %}
          * There is a Core update.
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","supervisor","True") %}
          * There is a Supervisor update.
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","hacs","True") %}
          {%- set updates = states("sensor.hacs")|int|default("0") %}
          {%- if updates == 1 %}
            * There is one HACS update.
          {%- else %}
            * There are {{ updates }} HACS updates.
          {%- endif %}
        {%- endif %}
        {%- if is_state_attr("sensor.home_assistant_updates","addons","True") %}
          {%- set updates = states("sensor.addon_updates")|int|default("0") %}
          {%- if updates == 1 %}
            * There is one Addon update.
          {%- else %}
            * There are {{ updates }} Addon updates.
          {%- endif %}
        {%- endif %}
      who: "brian"
